<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android,原创,Android群英传,控件," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="本章内容大多来自CSDN而不是群英传
Android控件架构Android控件树在Android中控件只有两种，一种就是View，另一种是ViewGroup。
通过ViewGroup，整个控件就至上而下的形成了树形结构，即我们通常所说的控件树。
父控件负责相应子控件的绘制与测量，并向其传递交互事件。
只需要调用findViewbyid的方法就能够按照深度优先的方法找到每一个控件了。
在每个控件树最">
<meta property="og:type" content="article">
<meta property="og:title" content="第三章：Android控件架构与自定义控件详解">
<meta property="og:url" content="http://yoursite.com/2016/10/03/第三章：Android控件架构与自定义控件详解/index.html">
<meta property="og:site_name" content="TokgoLiang的博客">
<meta property="og:description" content="本章内容大多来自CSDN而不是群英传
Android控件架构Android控件树在Android中控件只有两种，一种就是View，另一种是ViewGroup。
通过ViewGroup，整个控件就至上而下的形成了树形结构，即我们通常所说的控件树。
父控件负责相应子控件的绘制与测量，并向其传递交互事件。
只需要调用findViewbyid的方法就能够按照深度优先的方法找到每一个控件了。
在每个控件树最">
<meta property="og:image" content="http://7xu1cb.com1.z0.glb.clouddn.com/Android%E6%8E%A7%E4%BB%B6%E6%A0%91.png">
<meta property="og:image" content="http://7xu1cb.com1.z0.glb.clouddn.com/Android%E7%95%8C%E9%9D%A2%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="http://7xu1cb.com1.z0.glb.clouddn.com/%E5%BC%A7%E7%BA%BF%E5%B1%95%E7%A4%BA%E5%9B%BE.png">
<meta property="og:updated_time" content="2016-10-26T14:51:42.636Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第三章：Android控件架构与自定义控件详解">
<meta name="twitter:description" content="本章内容大多来自CSDN而不是群英传
Android控件架构Android控件树在Android中控件只有两种，一种就是View，另一种是ViewGroup。
通过ViewGroup，整个控件就至上而下的形成了树形结构，即我们通常所说的控件树。
父控件负责相应子控件的绘制与测量，并向其传递交互事件。
只需要调用findViewbyid的方法就能够按照深度优先的方法找到每一个控件了。
在每个控件树最">
<meta name="twitter:image" content="http://7xu1cb.com1.z0.glb.clouddn.com/Android%E6%8E%A7%E4%BB%B6%E6%A0%91.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/10/03/第三章：Android控件架构与自定义控件详解/"/>

  <title> 第三章：Android控件架构与自定义控件详解 | TokgoLiang的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">TokgoLiang的博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                第三章：Android控件架构与自定义控件详解
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-03T22:15:58+08:00" content="2016-10-03">
              2016-10-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android-读书笔记/" itemprop="url" rel="index">
                    <span itemprop="name">Android_读书笔记</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android-读书笔记/Android群英传/" itemprop="url" rel="index">
                    <span itemprop="name">Android群英传</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/03/第三章：Android控件架构与自定义控件详解/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/03/第三章：Android控件架构与自定义控件详解/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="http://blog.csdn.net/zizidemenghanxiao/article/details/50156467" title="本章内容大多来自CSDN而不是群英传" target="_blank" rel="external">本章内容大多来自CSDN而不是群英传</a></p>
<h1 id="Android控件架构"><a href="#Android控件架构" class="headerlink" title="Android控件架构"></a>Android控件架构</h1><h2 id="Android控件树"><a href="#Android控件树" class="headerlink" title="Android控件树"></a>Android控件树</h2><p>在Android中控件只有两种，一种就是View，另一种是ViewGroup。</p>
<p>通过ViewGroup，整个控件就至上而下的形成了树形结构，即我们通常所说的控件树。</p>
<p>父控件负责相应子控件的绘制与测量，并向其传递交互事件。</p>
<p>只需要调用findViewbyid的方法就能够按照深度优先的方法找到每一个控件了。</p>
<p>在每个控件树最顶端，都站立了一个Viewparent对象，这个对象也是这颗控件树的核心，所有的交互管理事件都是由这个大大负责统一分配和调度，从而起这一个整体宏观调控的效果。一个控件树架构如下图所示：</p>
<p><img src="http://7xu1cb.com1.z0.glb.clouddn.com/Android%E6%8E%A7%E4%BB%B6%E6%A0%91.png" alt="Android控件树架构图"></p>
<h2 id="Android界面架构"><a href="#Android界面架构" class="headerlink" title="Android界面架构"></a>Android界面架构</h2><p>通常情况下，在Activity中使用setContentView()方法来设置一个布局，在调用该方法后，布局内容才真正的显示出来。Android界面的架构图，如下：</p>
<p><img src="http://7xu1cb.com1.z0.glb.clouddn.com/Android%E7%95%8C%E9%9D%A2%E6%9E%B6%E6%9E%84.png" alt="Android界面架构图"></p>
<p>通过上图所示，我们可以得出这样的结论。</p>
<ol>
<li>每个activity都有一个window对象。</li>
<li>而每一个window对象通常是由PhoneWindow来实现。</li>
<li>每个PhoneWindow对象包含DecorView这个根视图对象，将其视图展示都是通过这个对象显示到PhoneWindow上。</li>
<li>而DecorView被一分为二，一个是TitleView，一个ContentView，TitleView显示相应的标题，ContentView显示具体布局，这些应该大家很熟悉。</li>
</ol>
<h1 id="ViewRoot和DecorView介绍"><a href="#ViewRoot和DecorView介绍" class="headerlink" title="ViewRoot和DecorView介绍"></a>ViewRoot和DecorView介绍</h1><h2 id="ViewRoot简介"><a href="#ViewRoot简介" class="headerlink" title="ViewRoot简介"></a>ViewRoot简介</h2><ol>
<li>ViewRoot对应于ViewRootImpl 类，它是连接 WindowManager 和 DecorView的纽带，View的三大流程（measure测量、layout布局、draw绘制）都是通过ViewRoot来完成的。</li>
<li>在ActivityThread 中，当Activity对象被创建完毕后，会将 DecorView 添加到Window中，同时会创建 ViewRootImpl对象，并将 ViewRootImpl对象和DecorView建立关联。</li>
<li><p>View的绘制流程是从ViewRoot 的 performTraversals 方法（源码在sources\android\view\ViewRootImpl.java）开始的，它经过 measure、layout和draw三个过程才能最终将一个View绘制出来，其中</p>
<ul>
<li>measure用来测量View的宽高</li>
<li>layout用来确定View在父容器中的放置位置</li>
<li>draw负责将View绘制在屏幕上</li>
</ul>
</li>
<li><p>Measure完成后，可以通过 getMeasuredWidth 和getMeasuredHeight 方法来获取到 View 测量后的宽高；Layout完成后，可以通过 getTop、getBottom、getLeft和getRight 来拿到View的四个顶点的位置，并可以通过 getWidth 和getHeight方法来拿到View的最终宽高；Draw完成后，View显示在屏幕上。</p>
</li>
</ol>
<h2 id="DecorView简介"><a href="#DecorView简介" class="headerlink" title="DecorView简介"></a>DecorView简介</h2><ol>
<li>DecorView作为顶级view，它的内部是一个竖直的LinearLayout,其中包括Title Bar和Content；</li>
<li>其中Activity中设置setContentView就是将布局文件加载在Content中；</li>
<li>Content是一个FrameLayout,可以布局优化；</li>
<li>可以通过ViewGroup content = findViewById(R.android.id.content);</li>
<li>可以通过content.getChildAt(index)获取View；</li>
</ol>
<h1 id="View的测量"><a href="#View的测量" class="headerlink" title="View的测量"></a>View的测量</h1><h2 id="MeasureSpec简介"><a href="#MeasureSpec简介" class="headerlink" title="MeasureSpec简介"></a>MeasureSpec简介</h2><ol>
<li>源码的位置android/view/View.java；</li>
<li>Android系统在绘制View之前，必须对View进行测量，这个过程在onMeasure()中进行，借助的是MeasureSpec类。MeasureSpec是一个32位的值，其中高两位代表测量模式SpecMode，低30位代表测量的大小SpecSize；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * A MeasureSpec encapsulates the layout requirements passed from parent to child.</div><div class="line">   * Each MeasureSpec represents a requirement for either the width or the height.</div><div class="line">   * A MeasureSpec is comprised of a size and a mode. There are three possible</div><div class="line">   * modes:</div><div class="line">   * &lt;dl&gt;</div><div class="line">   * &lt;dt&gt;UNSPECIFIED&lt;/dt&gt;</div><div class="line">   * &lt;dd&gt;</div><div class="line">   * The parent has not imposed any constraint on the child. It can be whatever size</div><div class="line">   * it wants.</div><div class="line">   * &lt;/dd&gt;</div><div class="line">   *</div><div class="line">   * &lt;dt&gt;EXACTLY&lt;/dt&gt;</div><div class="line">   * &lt;dd&gt;</div><div class="line">   * The parent has determined an exact size for the child. The child is going to be</div><div class="line">   * given those bounds regardless of how big it wants to be.</div><div class="line">   * &lt;/dd&gt;</div><div class="line">   *</div><div class="line">   * &lt;dt&gt;AT_MOST&lt;/dt&gt;</div><div class="line">   * &lt;dd&gt;</div><div class="line">   * The child can be as large as it wants up to the specified size.</div><div class="line">   * &lt;/dd&gt;</div><div class="line">   * &lt;/dl&gt;</div><div class="line">   *</div><div class="line">   * MeasureSpecs are implemented as ints to reduce object allocation. This class</div><div class="line">   * is provided to pack and unpack the &amp;lt;size, mode&amp;gt; tuple into the int.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MeasureSpec</span> </span>&#123;</div><div class="line"><span class="comment">//位移用的，后面表示大小的30位</span></div><div class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_SHIFT = <span class="number">30</span>;</div><div class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_MASK  = <span class="number">0x3</span> &lt;&lt; MODE_SHIFT;</div><div class="line"></div><div class="line">      <span class="comment">/** <span class="doctag">@hide</span> */</span></div><div class="line">      <span class="meta">@IntDef</span>(&#123;UNSPECIFIED, EXACTLY, AT_MOST&#125;)</div><div class="line">      <span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</div><div class="line">      <span class="keyword">public</span> <span class="meta">@interface</span> MeasureSpecMode &#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Measure specification mode: The parent has not imposed any constraint</div><div class="line">       * on the child. It can be whatever size it wants.</div><div class="line">       */</div><div class="line"><span class="comment">//dp,px,父容器对子元素没有任何约束，子元素可以是任意大小</span></div><div class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNSPECIFIED = <span class="number">0</span> &lt;&lt; MODE_SHIFT;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Measure specification mode: The parent has determined an exact size</div><div class="line">       * for the child. The child is going to be given those bounds regardless</div><div class="line">       * of how big it wants to be.</div><div class="line">       */</div><div class="line"><span class="comment">//match_parent，父容器决定子元素大小，子元素和父容器一样大小</span></div><div class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXACTLY     = <span class="number">1</span> &lt;&lt; MODE_SHIFT;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Measure specification mode: The child can be as large as it wants up</div><div class="line">       * to the specified size.</div><div class="line">       */</div><div class="line"><span class="comment">//wrap_content,子元素不可以超过父容器的大小</span></div><div class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AT_MOST     = <span class="number">2</span> &lt;&lt; MODE_SHIFT;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Creates a measure specification based on the supplied size and mode.</div><div class="line">       *</div><div class="line">       * The mode must always be one of the following:</div><div class="line">       * &lt;ul&gt;</div><div class="line">       *  &lt;li&gt;&#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#UNSPECIFIED&#125;&lt;/li&gt;</div><div class="line">       *  &lt;li&gt;&#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#EXACTLY&#125;&lt;/li&gt;</div><div class="line">       *  &lt;li&gt;&#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#AT_MOST&#125;&lt;/li&gt;</div><div class="line">       * &lt;/ul&gt;</div><div class="line">       *</div><div class="line">       * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; On API level 17 and lower, makeMeasureSpec's</div><div class="line">       * implementation was such that the order of arguments did not matter</div><div class="line">       * and overflow in either value could impact the resulting MeasureSpec.</div><div class="line">       * &#123;<span class="doctag">@link</span> android.widget.RelativeLayout&#125; was affected by this bug.</div><div class="line">       * Apps targeting API levels greater than 17 will get the fixed, more strict</div><div class="line">       * behavior.&lt;/p&gt;</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> size the size of the measure specification</div><div class="line">       * <span class="doctag">@param</span> mode the mode of the measure specification</div><div class="line">       * <span class="doctag">@return</span> the measure specification based on size and mode</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">makeMeasureSpec</span><span class="params">(@IntRange(from = <span class="number">0</span>, to = (<span class="number">1</span> &lt;&lt; MeasureSpec.MODE_SHIFT)</span> - 1) <span class="keyword">int</span> size,</span></div><div class="line">                                        @MeasureSpecMode <span class="keyword">int</span> mode) &#123;</div><div class="line">          <span class="keyword">if</span> (sUseBrokenMakeMeasureSpec) &#123;</div><div class="line">              <span class="keyword">return</span> size + mode;</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">              <span class="keyword">return</span> (size &amp; ~MODE_MASK) | (mode &amp; MODE_MASK);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Like &#123;<span class="doctag">@link</span> #makeMeasureSpec(int, int)&#125;, but any spec with a mode of UNSPECIFIED</div><div class="line">       * will automatically get a size of 0. Older apps expect this.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@hide</span> internal use only for compatibility with system widgets and older apps</div><div class="line">       */</div><div class="line"><span class="comment">//将size和mode打包成一个32位的int值返回</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">makeSafeMeasureSpec</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> mode)</span> </span>&#123;</div><div class="line">          <span class="keyword">if</span> (sUseZeroUnspecifiedMeasureSpec &amp;&amp; mode == UNSPECIFIED) &#123;</div><div class="line">              <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> makeMeasureSpec(size, mode);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Extracts the mode from the supplied measure specification.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> measureSpec the measure specification to extract the mode from</div><div class="line">       * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#UNSPECIFIED&#125;,</div><div class="line">       *         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#AT_MOST&#125; or</div><div class="line">       *         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec#EXACTLY&#125;</div><div class="line">       */</div><div class="line">      <span class="meta">@MeasureSpecMode</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMode</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">          <span class="comment">//noinspection ResourceType</span></div><div class="line">          <span class="keyword">return</span> (measureSpec &amp; MODE_MASK);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Extracts the size from the supplied measure specification.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> measureSpec the measure specification to extract the size from</div><div class="line">       * <span class="doctag">@return</span> the size in pixels defined in the supplied measure specification</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> (measureSpec &amp; ~MODE_MASK);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">adjust</span><span class="params">(<span class="keyword">int</span> measureSpec, <span class="keyword">int</span> delta)</span> </span>&#123;</div><div class="line">          <span class="keyword">final</span> <span class="keyword">int</span> mode = getMode(measureSpec);</div><div class="line">          <span class="keyword">int</span> size = getSize(measureSpec);</div><div class="line">          <span class="keyword">if</span> (mode == UNSPECIFIED) &#123;</div><div class="line">              <span class="comment">// No need to adjust size for UNSPECIFIED mode.</span></div><div class="line">              <span class="keyword">return</span> makeMeasureSpec(size, UNSPECIFIED);</div><div class="line">          &#125;</div><div class="line">          size += delta;</div><div class="line">          <span class="keyword">if</span> (size &lt; <span class="number">0</span>) &#123;</div><div class="line">              Log.e(VIEW_LOG_TAG, <span class="string">"MeasureSpec.adjust: new size would be negative! ("</span> + size +</div><div class="line">                      <span class="string">") spec: "</span> + toString(measureSpec) + <span class="string">" delta: "</span> + delta);</div><div class="line">              size = <span class="number">0</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> makeMeasureSpec(size, mode);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Returns a String representation of the specified measure</div><div class="line">       * specification.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> measureSpec the measure specification to convert to a String</div><div class="line">       * <span class="doctag">@return</span> a String with the following format: "MeasureSpec: MODE SIZE"</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toString</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">          <span class="keyword">int</span> mode = getMode(measureSpec);</div><div class="line">          <span class="keyword">int</span> size = getSize(measureSpec);</div><div class="line"></div><div class="line">          StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">"MeasureSpec: "</span>);</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (mode == UNSPECIFIED)</div><div class="line">              sb.append(<span class="string">"UNSPECIFIED "</span>);</div><div class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (mode == EXACTLY)</div><div class="line">              sb.append(<span class="string">"EXACTLY "</span>);</div><div class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (mode == AT_MOST)</div><div class="line">              sb.append(<span class="string">"AT_MOST "</span>);</div><div class="line">          <span class="keyword">else</span></div><div class="line">              sb.append(mode).append(<span class="string">" "</span>);</div><div class="line"></div><div class="line">          sb.append(size);</div><div class="line">          <span class="keyword">return</span> sb.toString();</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>MeasureSpec的测量模式有三种：</p>
<ol>
<li>EXACTLY：具体值或者 match_parent。onMeasure（）方法默认情况下只支持这种模式。</li>
<li>AT_MOST：wrap_content。不可以比父容器大就可以了，不过通常控件都会有一个默认值。</li>
<li>UNSPECIFIED：View想多大就多大，通常自定义View时使用。<br><strong>注意点：要让自定义View支持 wrap_content 属性，就必须重写onMeasure（）方法来指定wrap_content时的大小。</strong></li>
</ol>
<h2 id="MeasurSpec和LayoutParams的对应关系"><a href="#MeasurSpec和LayoutParams的对应关系" class="headerlink" title="MeasurSpec和LayoutParams的对应关系"></a>MeasurSpec和LayoutParams的对应关系</h2><ol>
<li>View在测量的时候，系统会将LayoutParams在父容器的约束下转换成对应的MeasureSpec，然后再根据MeasureSpec来确定View测量后的宽高；</li>
<li>MeasureSpec不仅有LayoutParams决定，还有父容器的大小影响；</li>
<li>DecorView比较特殊，它由LayoutParams和出口的尺寸来决定，他没有父容器；</li>
<li>MeasureSpec一旦确定，onMeasure中就可以确定View的测量宽高；</li>
</ol>
<p>下面看看DecorView在ViewRootImpl中的源码：</p>
<ol>
<li>DecorView的MeasureSpec创建过程，在measureHierarchy函数中有如下语句：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (baseSize != <span class="number">0</span> &amp;&amp; desiredWindowWidth &gt; baseSize) &#123;</div><div class="line">                childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width);</div><div class="line">                childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);</div><div class="line">                performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div></pre></td></tr></table></figure>
</li>
</ol>
<p>desiredWindowHeight指的是屏幕的高度，那个desiredWindowWidth不能超过baseSize，不然。。。。呵呵,不知道。<br>if下面的两句的作用是获得宽高，第三句就是通过performMeasure来设置宽高了。</p>
<ol>
<li>接下来看看里面的getRootMeasureSpec 方法：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Figures out the measure spec for the root view in a window based on it's</div><div class="line">     * layout params.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> windowSize</div><div class="line">     *            The available width or height of the window</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> rootDimension</div><div class="line">     *            The layout params for one dimension (width or height) of the</div><div class="line">     *            window.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> The measure spec to use to measure the root view.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getRootMeasureSpec</span><span class="params">(<span class="keyword">int</span> windowSize, <span class="keyword">int</span> rootDimension)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> measureSpec;</div><div class="line">        <span class="keyword">switch</span> (rootDimension) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT:</div><div class="line">            <span class="comment">// Window can't resize. Force root view to be windowSize.</span></div><div class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> ViewGroup.LayoutParams.WRAP_CONTENT:</div><div class="line">            <span class="comment">// Window can resize. Set max size for root view.</span></div><div class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="comment">// Window wants to be an exact size. Force root view to be that size.</span></div><div class="line">            measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> measureSpec;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这个方法很明显了，进来以后通过第二个参数来判断啦是用窗口大小还是用LinearLayout的值。其中的makeMeasureSpec是SpecMode和SpecSize的打包组合。</p>
<p>下面看看普通的View，这里是指我们布局中的View：</p>
<ol>
<li><p>View的measure过程由ViewGroup传递而来，先看一下ViewGroup的measureChildWithMargins 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Ask one of the children of this view to measure itself, taking into</div><div class="line">    * account both the MeasureSpec requirements for this view and its padding</div><div class="line">    * and margins. The child must have MarginLayoutParams The heavy lifting is</div><div class="line">    * done in getChildMeasureSpec.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> child The child to measure</div><div class="line">    * <span class="doctag">@param</span> parentWidthMeasureSpec The width requirements for this view</div><div class="line">    * <span class="doctag">@param</span> widthUsed Extra space that has been used up by the parent</div><div class="line">    *        horizontally (possibly by other children of the parent)</div><div class="line">    * <span class="doctag">@param</span> parentHeightMeasureSpec The height requirements for this view</div><div class="line">    * <span class="doctag">@param</span> heightUsed Extra space that has been used up by the parent</div><div class="line">    *        vertically (possibly by other children of the parent)</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></div><div class="line">           <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</div><div class="line">           <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed) &#123;</div><div class="line">       <span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line"><span class="comment">/* 也是先获取子元素的MeasureSpec， </span></div><div class="line">    * getChildMeasureSpec这里的参数，第一个就变成了父类的大小， </div><div class="line">    * 第二个参数是上下左右的边距 </div><div class="line">    * 第三个参数是LinearLayout的宽高 </div><div class="line">    */  </div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</div><div class="line">               mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</div><div class="line">                       + widthUsed, lp.width);</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</div><div class="line">               mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</div><div class="line">                       + heightUsed, lp.height);</div><div class="line">	<span class="comment">//得到子元素的MeasureSpec后，调用子元素的measure来设置宽高</span></div><div class="line">       child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>我们也来看看getChildMeasureSpec方法：其中的padding指的是父容器中已占用的空间大小。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    /**</div><div class="line">     * Does the hard part of measureChildren: figuring out the MeasureSpec to</div><div class="line">     * pass to a particular child. This method figures out the right MeasureSpec</div><div class="line">     * for one dimension (height or width) of one child view.</div><div class="line">     *</div><div class="line">     * The goal is to combine information from our MeasureSpec with the</div><div class="line">     * LayoutParams of the child to get the best possible results. For example,</div><div class="line">     * if the this view knows its size (because its MeasureSpec has a mode of</div><div class="line">     * EXACTLY), and the child has indicated in its LayoutParams that it wants</div><div class="line">     * to be the same size as the parent, the parent should ask the child to</div><div class="line">     * layout given an exact size.</div><div class="line">     *</div><div class="line">     * @param spec The requirements for this view</div><div class="line">     * @param padding The padding of this view for the current dimension and</div><div class="line">     *        margins, if applicable</div><div class="line">     * @param childDimension How big the child wants to be in the current</div><div class="line">     *        dimension</div><div class="line">     * @return a MeasureSpec integer for the child</div><div class="line">     */</div><div class="line">    public static int getChildMeasureSpec(int spec, int padding, int childDimension) &#123;</div><div class="line">        int specMode = MeasureSpec.getMode(spec);</div><div class="line">        int specSize = MeasureSpec.getSize(spec);</div><div class="line"></div><div class="line">        int size = Math.max(0, specSize - padding);</div><div class="line"></div><div class="line">        int resultSize = 0;</div><div class="line">        int resultMode = 0;</div><div class="line"></div><div class="line">        switch (specMode) &#123;</div><div class="line">        // Parent has imposed an exact size on us</div><div class="line">        case MeasureSpec.EXACTLY:</div><div class="line">            if (childDimension &gt;= 0) &#123;</div><div class="line">                resultSize = childDimension;</div><div class="line">                resultMode = MeasureSpec.EXACTLY;</div><div class="line">            &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                // Child wants to be our size. So be it.</div><div class="line">                resultSize = size;</div><div class="line">                resultMode = MeasureSpec.EXACTLY;</div><div class="line">            &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">                // Child wants to determine its own size. It can't be</div><div class="line">                // bigger than us.</div><div class="line">                resultSize = size;</div><div class="line">                resultMode = MeasureSpec.AT_MOST;</div><div class="line">            &#125;</div><div class="line">            break;</div><div class="line"></div><div class="line">        // Parent has imposed a maximum size on us</div><div class="line">        case MeasureSpec.AT_MOST:</div><div class="line">            if (childDimension &gt;= 0) &#123;</div><div class="line">                // Child wants a specific size... so be it</div><div class="line">                resultSize = childDimension;</div><div class="line">                resultMode = MeasureSpec.EXACTLY;</div><div class="line">            &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                // Child wants to be our size, but our size is not fixed.</div><div class="line">                // Constrain child to not be bigger than us.</div><div class="line">                resultSize = size;</div><div class="line">                resultMode = MeasureSpec.AT_MOST;</div><div class="line">            &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">                // Child wants to determine its own size. It can't be</div><div class="line">                // bigger than us.</div><div class="line">                resultSize = size;</div><div class="line">                resultMode = MeasureSpec.AT_MOST;</div><div class="line">            &#125;</div><div class="line">            break;</div><div class="line"></div><div class="line">        // Parent asked to see how big we want to be</div><div class="line">        case MeasureSpec.UNSPECIFIED:</div><div class="line">            if (childDimension &gt;= 0) &#123;</div><div class="line">                // Child wants a specific size... let him have it</div><div class="line">                resultSize = childDimension;</div><div class="line">                resultMode = MeasureSpec.EXACTLY;</div><div class="line">            &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                // Child wants to be our size... find out how big it should</div><div class="line">                // be</div><div class="line">                resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;</div><div class="line">                resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">            &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">                // Child wants to determine its own size.... find out how</div><div class="line">                // big it should be</div><div class="line">                resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;</div><div class="line">                resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">            &#125;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        //noinspection ResourceType</div><div class="line">        return MeasureSpec.makeMeasureSpec(resultSize, resultMode);</div><div class="line">    &#125;</div><div class="line">``` </div><div class="line"></div><div class="line">搞个表格来说明以下上面代码的逻辑：</div><div class="line"></div><div class="line">![普通View的MeasureSpec的创建规则](http://7xu1cb.com1.z0.glb.clouddn.com/MeasureSpec%E7%9A%84%E5%88%9B%E5%BB%BA%E8%A7%84%E5%88%99.png)</div><div class="line"></div><div class="line">就是说只要子元素的LinearLayout是精确值，那子元素就是精确值。</div><div class="line">子元素如果是match_parent，那子元素就和父容器一样大小。</div><div class="line">子元素如果是wrap_content，那子元素就不能超过父容器的剩余空间大小。</div><div class="line"></div><div class="line">## 看看具体的onMeasure实现和如何重写这个方法 ##</div><div class="line"></div><div class="line">1. 原始的onMeasure在源码中是这样的，也就是重写时它自动构成这样：</div><div class="line">``` java</div><div class="line">@Override  </div><div class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;  </div><div class="line">    super.onMeasure(widthMeasureSpec, heightMeasureSpec);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>然后我们去查看 super.onMeasure（）方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),  </div><div class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>可以发现超类中调用了setMeasuredDimension（）方法，它的两个参数是 MeasureSpec 类型变量，这个方法将测量后的宽高值设置进去，从而完成测量工作。</p>
<ol>
<li><p>所以当我们想要重写onMeasure（）方法时，可以直接重写超类中的setMeasuredDimension（）方法，同时自定义两个测量宽高的方法 measureWidth() 和 measureHeight() 来处理 MeasureSpec 类型变量，返回宽高值Size;在超类中是以getDefaultSize()来处理 MeasureSpec 类型变量的，这里我们换成自己写的 measureWidth() 和 measureHeight() 方法：（<strong>注意啦，这里getDefaultSize返回的是size大小，也就是说将MeasureSpec中的size部分返回。</strong>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">    setMeasuredDimension(  </div><div class="line">            measureWidth(widthMeasureSpec),  </div><div class="line">            measureHeight(heightMeasureSpec));  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>下面就看看需要编写的measureWidth（）方法如何实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">measureWidth</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;  </div><div class="line">      </div><div class="line">    <span class="comment">// 首先从MeasureSpec对象中提取出具体的测量模式和大小：  </span></div><div class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);  </div><div class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);  </div><div class="line">  </div><div class="line">    <span class="comment">// 直接返回精确值  </span></div><div class="line">    <span class="keyword">if</span> (specMode == MeasureSpec.EXACTLY) &#123;  </div><div class="line">        result = specSize;  </div><div class="line">    &#125; <span class="keyword">else</span> &#123;  </div><div class="line">        <span class="comment">// 另外两种模式，200是默认大小  </span></div><div class="line">        result = <span class="number">200</span>;  </div><div class="line">        <span class="comment">// 但如果是AT_MOST即wrap_content时，还需要取两者的最小值。  </span></div><div class="line">        <span class="comment">// 所以通常情况下，如果我们不重写onMeasure（）方法时，都会给这个控件一个默认的比如说200的大小  </span></div><div class="line">        <span class="comment">// 但如果重写了，这里就可以为wrap_content设置一个其他的默认大小。  </span></div><div class="line">        <span class="keyword">if</span> (specMode == MeasureSpec.AT_MOST) &#123;  </div><div class="line">            result = Math.min(result, specSize);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">return</span> result;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="View的measure过程"><a href="#View的measure过程" class="headerlink" title="View的measure过程"></a>View的measure过程</h1><h2 id="View的measure过程-1"><a href="#View的measure过程-1" class="headerlink" title="View的measure过程"></a>View的measure过程</h2><ol>
<li>源码位置：sources\android\view\View.java</li>
<li>View的measure过程由measure方法来完成，measure方法是一个final类型的方法，意味着子类不能重写此方法，<br>在View的measure方法中会调用VIew的onMeasure 方法，所以只需要看onMeasure方法就可以了：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),  </div><div class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>代码很简单，setMeasuredDimension 方法会设置View宽高的测量值，因此我们主要看看getDefaultSize 这个方法，第一个参数是getSuggestedMinimumWidth返回值，第二个参数是MeasureSpec的测量宽值。</p>
<ol>
<li>getDefaultSize方法的实现：返回的是size值。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Utility to return a default size. Uses the supplied size if the</div><div class="line"> * MeasureSpec imposed no constraints. Will get larger if allowed</div><div class="line"> * by the MeasureSpec.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> size Default size for this view</div><div class="line"> * <span class="doctag">@param</span> measureSpec Constraints imposed by the parent</div><div class="line"> * <span class="doctag">@return</span> The size this view should be.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> result = size;</div><div class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (specMode) &#123;</div><div class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">        result = size;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">        result = specSize;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>这里有关于wrap_content的重点：</strong><br>我们从这个方法可以得出，View的宽高是由specSize决定的，所以我们可以直接继承View的自定义控件需要重写onMeasure方法并设置wrap_content时的自身大小，<br>否则在布局中使用wrap_content就相当于使用match_parent。<br>什么意思呢？就是说默认情况下，上面代码中写的AT_MOST和EXACTLY这两种case的返回值都是specSize，<br>但是我们可以在自定义的View中设置wrap_content的大小，使得它有一个自己默认的大小。<br>所以在大多数的控件中，比如说TextView、ImageView等的源码就可以知道，针对wrap_content情形，它们的 onMeasure 方法均作了特殊的处理。<br>我们这里给一个自己可以重写onMeasure的代码（其实我们刚刚上面也给了一个重写的方法了啊，差不多的）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);  </div><div class="line">  </div><div class="line">    <span class="keyword">int</span> widthSpaceSize = MeasureSpec.getSize(widthMeasureSpec);  </div><div class="line">    <span class="keyword">int</span> widthSpecMode = MeasureSpec.getMode(widthMeasureSpec);  </div><div class="line">    <span class="keyword">int</span> heightSpaceSize = MeasureSpec.getSize(heightMeasureSpec);  </div><div class="line">    <span class="keyword">int</span> heightSpecMode = MeasureSpec.getMode(heightMeasureSpec);  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; heightSpecMode == MeasureSpec.AT_MOST) &#123;  </div><div class="line">        setMeasuredDimension(mWidth, mHight);  </div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST) &#123;  </div><div class="line">        setMeasuredDimension(mWidth, heightSpaceSize);  </div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightSpecMode == MeasureSpec.AT_MOST)&#123;  </div><div class="line">        setMeasuredDimension(widthSpaceSize, mHight);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>setMeasuredDimension 方法中的第一个参数是getSuggestedMinimumWidth方法返回的：<br>它返回的是View在UNSPECIFIED情况下的测量宽高。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Returns the suggested minimum width that the view should use. This </div><div class="line"> * returns the maximum of the view's minimum width) </div><div class="line"> * and the background's minimum width </div><div class="line"> *  (&#123;<span class="doctag">@link</span> android.graphics.drawable.Drawable#getMinimumWidth()&#125;). </div><div class="line"> * &lt;p&gt; </div><div class="line"> * When being used in &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125;, the caller should still </div><div class="line"> * ensure the returned width is within the requirements of the parent. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@return</span> The suggested minimum width of the view. </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>如果View没有设置背景，那么View的宽度就是mMinWidh，这个值对应于android:minWidth，这个值默认是为0的。<br>如果View设置了背景，那么View的宽度就是max(mMinWidth, mBackground.getMinimumWidth())。那mBackground.getMinimumWidth()呢？</p>
<ol>
<li>mBackground.getMinimumWidth()：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Returns the minimum width suggested by this Drawable. If a View uses this </div><div class="line"> * Drawable as a background, it is suggested that the View use at least this </div><div class="line"> * value for its width. (There will be some scenarios where this will not be </div><div class="line"> * possible.) This value should INCLUDE any padding. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@return</span> The minimum width suggested by this Drawable. If this Drawable </div><div class="line"> *         doesn't have a suggested minimum width, 0 is returned. </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMinimumWidth</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> intrinsicWidth = getIntrinsicWidth();  </div><div class="line">    <span class="keyword">return</span> intrinsicWidth &gt; <span class="number">0</span> ? intrinsicWidth : <span class="number">0</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>可以看到他返回的就是Drawable的原始宽度，前提是这个Drawable有原始宽度，否则就返回0.<br>那么Drawable在什么情况下有原始宽度呢？ShapeDrawable无原始宽高，而BitmapDrawable有原始宽高（图片的尺寸）。</p>
<h2 id="ViewGroup的measure过程"><a href="#ViewGroup的measure过程" class="headerlink" title="ViewGroup的measure过程"></a>ViewGroup的measure过程</h2><ol>
<li>源码位置：sources\android\view\ViewGroup.java</li>
<li>对于ViewGroup而言，除了完成自己的measure过程以外，还会去遍历去调用所有子元素的measure方法，各个子元素再递归去执行这个过程。</li>
<li><p>和View不同的是，ViewGroup是一个抽象类，因此它没有重写View的onMeasure方法，但它提供了一个叫 measureChildren的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Ask all of the children of this view to measure themselves, taking into </div><div class="line"> * account both the MeasureSpec requirements for this view and its padding. </div><div class="line"> * We skip children that are in the GONE state The heavy lifting is done in </div><div class="line"> * getChildMeasureSpec. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec The width requirements for this view </div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec The height requirements for this view </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mChildrenCount;  </div><div class="line">    <span class="keyword">final</span> View[] children = mChildren;  </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;  </div><div class="line">        <span class="keyword">final</span> View child = children[i];  </div><div class="line">        <span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) &#123;  </div><div class="line">            measureChild(child, widthMeasureSpec, heightMeasureSpec);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在measureChildren中有一个measureChild：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Ask one of the children of this view to measure itself, taking into </div><div class="line"> * account both the MeasureSpec requirements for this view and its padding. </div><div class="line"> * The heavy lifting is done in getChildMeasureSpec. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> child The child to measure </div><div class="line"> * <span class="doctag">@param</span> parentWidthMeasureSpec The width requirements for this view </div><div class="line"> * <span class="doctag">@param</span> parentHeightMeasureSpec The height requirements for this view </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChild</span><span class="params">(View child, <span class="keyword">int</span> parentWidthMeasureSpec,  </span></span></div><div class="line">        <span class="keyword">int</span> parentHeightMeasureSpec) &#123;  </div><div class="line">    <span class="keyword">final</span> LayoutParams lp = child.getLayoutParams();  </div><div class="line">  </div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,  </div><div class="line">            mPaddingLeft + mPaddingRight, lp.width);  </div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,  </div><div class="line">            mPaddingTop + mPaddingBottom, lp.height);  </div><div class="line">  </div><div class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>取出子元素的LayoutParams，然后再通过getChildMeasureSpec来创建子元素的MeasureSpec，再然后将它直接传递给View的measure方法来进行测量。</p>
<ol>
<li>在ViewGroup中并没有定义其测量的具体过程，因为ViewGroup是一个抽象类，它的测量过程的onMeasure方法需要各个子类去实现，比如LinearLayout、RelativeLayout等，<br>因为不同的子类有不同的布局特性，这导致它们的测量细节各不相同。因此ViewGroup无法做统一实现。</li>
<li>我们以LinearLayout为例来讲一下ViewGroup：<br>源码位置：sources\android\widget\LinearLayout.java<br>先看看它的onMeasure方法：很简单<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (mOrientation == VERTICAL) &#123;  </div><div class="line">        measureVertical(widthMeasureSpec, heightMeasureSpec);  </div><div class="line">    &#125; <span class="keyword">else</span> &#123;  </div><div class="line">        measureHorizontal(widthMeasureSpec, heightMeasureSpec);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>再去看看measureVertical方法：比较长，我们删掉了很多，留下了一部分代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Measures the children when the orientation of this LinearLayout is set </div><div class="line"> * to &#123;<span class="doctag">@link</span> #VERTICAL&#125;. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Horizontal space requirements as imposed by the parent. </div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Vertical space requirements as imposed by the parent. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@see</span> #getOrientation() </div><div class="line"> * <span class="doctag">@see</span> #setOrientation(int) </div><div class="line"> * <span class="doctag">@see</span> #onMeasure(int, int) </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">measureVertical</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">  </div><div class="line">    ...  </div><div class="line">  </div><div class="line">    <span class="comment">// See how tall everyone is. Also remember max width.  </span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;  </div><div class="line">        <span class="keyword">final</span> View child = getVirtualChildAt(i);  </div><div class="line">  </div><div class="line">        ...  </div><div class="line">  </div><div class="line">            <span class="comment">// Determine how big this child would like to be. If this or  </span></div><div class="line">            <span class="comment">// previous children have given a weight, then we allow it to  </span></div><div class="line">            <span class="comment">// use all available space (and we will shrink things later  </span></div><div class="line">            <span class="comment">// if needed).  </span></div><div class="line">            <span class="comment">/* </span></div><div class="line">             * 遍历子元素并对子元素执行这个方法， </div><div class="line">             * 这个方法内部会调用子元素的measure方法， </div><div class="line">             * 这样各个子元素就开始一次进入measure过程， </div><div class="line">             * 并且系统会通过mTotalLength这个变量来存储LinearLayout在竖直方向的初步高度。 </div><div class="line">             * 没测量一个子元素，mTotalLength都会增加。 </div><div class="line">             * */  </div><div class="line">            measureChildBeforeLayout(  </div><div class="line">                   child, i, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec,  </div><div class="line">                   totalWeight == <span class="number">0</span> ? mTotalLength : <span class="number">0</span>);  </div><div class="line">  </div><div class="line">            <span class="keyword">if</span> (oldHeight != Integer.MIN_VALUE) &#123;  </div><div class="line">               lp.height = oldHeight;  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();  </div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;  </div><div class="line">            mTotalLength = Math.max(totalLength, totalLength + childHeight + lp.topMargin +  </div><div class="line">                   lp.bottomMargin + getNextLocationOffset(child));  </div><div class="line">  </div><div class="line">            ...  </div><div class="line">        &#125;  </div><div class="line">      </div><div class="line">    ...  </div><div class="line">  </div><div class="line">    <span class="comment">// Add in our padding  </span></div><div class="line">    mTotalLength += mPaddingTop + mPaddingBottom;  </div><div class="line">  </div><div class="line">    <span class="keyword">int</span> heightSize = mTotalLength;  </div><div class="line">  </div><div class="line">    <span class="comment">// Check against our minimum height  </span></div><div class="line">    heightSize = Math.max(heightSize, getSuggestedMinimumHeight());  </div><div class="line">      </div><div class="line">    <span class="comment">// Reconcile our calculated size with the heightMeasureSpec  </span></div><div class="line">    <span class="keyword">int</span> heightSizeAndState = resolveSizeAndState(heightSize, heightMeasureSpec, <span class="number">0</span>);  </div><div class="line">    heightSize = heightSizeAndState &amp; MEASURED_SIZE_MASK;  </div><div class="line">      </div><div class="line">    ...  </div><div class="line">      </div><div class="line">    <span class="comment">// 等子元素都测量完毕后，LinearLayout测量自己的大小：  </span></div><div class="line">    setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),<span class="comment">//这个方法在下面有介绍  </span></div><div class="line">            heightSizeAndState);  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (matchWidth) &#123;  </div><div class="line">        forceUniformWidth(count, heightMeasureSpec);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>针对竖直的LinearLayout而言，它的水平方向的测量遵循View的测量过程，在竖直方向的测量过程则和View有所不同。<br>具体来说，如果它的布局中高度采用的是match_parent或者具体数值，那么它的测量过程和View一致，即高度为specSize；<br>如果它的布局中高度曹勇的是wrap_content，那么它的高度是所有子元素所占用的高度总和，但是仍然不能超过它的父容器的剩余空间，<br>当然它的最终高度还需要考虑其在竖直方向的padding，这个过程可以参考如下的源码：这个方法是在View.java中实现的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line"> * Utility to reconcile a desired size and state, with constraints imposed </div><div class="line"> * by a MeasureSpec.  Will take the desired size, unless a different size </div><div class="line"> * is imposed by the constraints.  The returned value is a compound integer, </div><div class="line"> * with the resolved size in the &#123;@link #MEASURED_SIZE_MASK&#125; bits and </div><div class="line"> * optionally the bit &#123;@link #MEASURED_STATE_TOO_SMALL&#125; set if the resulting </div><div class="line"> * size is smaller than the size the view wants to be. </div><div class="line"> * </div><div class="line"> * @param size How big the view wants to be </div><div class="line"> * @param measureSpec Constraints imposed by the parent </div><div class="line"> * @return Size information bit mask as defined by </div><div class="line"> * &#123;@link #MEASURED_SIZE_MASK&#125; and &#123;@link #MEASURED_STATE_TOO_SMALL&#125;. </div><div class="line"> */  </div><div class="line">public static int resolveSizeAndState(int size, int measureSpec, int childMeasuredState) &#123;  </div><div class="line">    int result = size;  </div><div class="line">    int specMode = MeasureSpec.getMode(measureSpec);  </div><div class="line">    int specSize =  MeasureSpec.getSize(measureSpec);  </div><div class="line">    switch (specMode) &#123;  </div><div class="line">    case MeasureSpec.UNSPECIFIED:  </div><div class="line">        result = size;  </div><div class="line">        break;  </div><div class="line">    case MeasureSpec.AT_MOST:  </div><div class="line">        if (specSize &lt; size) &#123;  </div><div class="line">            result = specSize | MEASURED_STATE_TOO_SMALL;  </div><div class="line">        &#125; else &#123;  </div><div class="line">            result = size;  </div><div class="line">        &#125;  </div><div class="line">        break;  </div><div class="line">    case MeasureSpec.EXACTLY:  </div><div class="line">        result = specSize;  </div><div class="line">        break;  </div><div class="line">    &#125;  </div><div class="line">    return result | (childMeasuredState&amp;MEASURED_STATE_MASK);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到此为止，measure完成以后，通过 个图MeasuredWidth、MeasuredHeight方法就可以正确地获取到View的测量宽高。<br>注意点：在某些极端情况下，系统需要多次测量measure才能确定最终的测量宽高，这种情况下，在onMeasure方法中拿到的测量宽高很可能是不准确的。<br>一个比较好的习惯是在onLayout方法中去获取View的测量宽高或者说是最终宽高。</p>
<h2 id="解决View的measure过程和Activity生命周期不同步的问题"><a href="#解决View的measure过程和Activity生命周期不同步的问题" class="headerlink" title="解决View的measure过程和Activity生命周期不同步的问题"></a>解决View的measure过程和Activity生命周期不同步的问题</h2><ol>
<li><p>当我们想要在Activity已启动的时候就做一个任务，但是这个任务需要获取某个View 的宽高。但是由于View的measure和Activity的生命周期不同步执行，因此无法保证Activity执行了onCreate、onStart、onResume时某个View已经测量完毕了，如果View 还没有测量完毕，那么获得的宽高就是0，具体的解决方法有四种：</p>
</li>
<li><p>解决方法一：onWindowFocusChanged<br>源码位置：sources\android\view\View.java。<br>onWindowFocusChanged 这个方法的含义是：View已经初始化完毕了，宽高已经准备好了，这个时候获取宽高是没有问题的。<br>onWindowFocusChanged会被调用多次，当Activity的窗口得到焦点或失去焦点的时候都会被调用一次。<br>也就是说，当Activity继续执行或暂停执行的时候，onWindowFocusChanged就会被调用。<br>那如果频繁的onResume或onPause时，onWindowFocusChanged 也会被频繁的调用。<br>源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Called when the window containing this view gains or loses focus.  Note </div><div class="line"> * that this is separate from view focus: to receive key events, both </div><div class="line"> * your view and its window must have focus.  If a window is displayed </div><div class="line"> * on top of yours that takes input focus, then your own window will lose </div><div class="line"> * focus but the view focus will remain unchanged. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> hasWindowFocus True if the window containing this view now has </div><div class="line"> *        focus, false otherwise. </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasWindowFocus)</span> </span>&#123;  </div><div class="line">    InputMethodManager imm = InputMethodManager.peekInstance();  </div><div class="line">    <span class="keyword">if</span> (!hasWindowFocus) &#123;  </div><div class="line">        <span class="keyword">if</span> (isPressed()) &#123;  </div><div class="line">            setPressed(<span class="keyword">false</span>);  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">if</span> (imm != <span class="keyword">null</span> &amp;&amp; (mPrivateFlags &amp; PFLAG_FOCUSED) != <span class="number">0</span>) &#123;  </div><div class="line">            imm.focusOut(<span class="keyword">this</span>);  </div><div class="line">        &#125;  </div><div class="line">        removeLongPressCallback();  </div><div class="line">        removeTapCallback();  </div><div class="line">        onFocusLost();  </div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (imm != <span class="keyword">null</span> &amp;&amp; (mPrivateFlags &amp; PFLAG_FOCUSED) != <span class="number">0</span>) &#123;  </div><div class="line">        imm.focusIn(<span class="keyword">this</span>);  </div><div class="line">    &#125;  </div><div class="line">    refreshDrawableState();  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>重写onWindowFocusChanged 代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasFocus)</span> </span>&#123;  </div><div class="line">    <span class="keyword">super</span>.onWindowFocusChanged(hasFocus);  </div><div class="line">    <span class="comment">// 如果重新获得焦点，那就获取宽高值：  </span></div><div class="line">    <span class="keyword">if</span>(hasFocus)&#123;  </div><div class="line">        <span class="keyword">int</span> width = view.getMeasuredWidth();  </div><div class="line">        <span class="keyword">int</span> height = view.getMeasureHeight();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li><p>解决方法二：view.post(runnable)<br>源码位置：sources\android\app\Activity.java。<br>通过post可以将一个runnable投递到消息队列的尾部，然后等待Looper调用此runnable的时候，View 也已经初始化好了。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">super</span>.onStart();  </div><div class="line">      </div><div class="line">    view.post(<span class="keyword">new</span> Runnable)&#123;  </div><div class="line">        <span class="meta">@Override</span>  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;  </div><div class="line">            <span class="keyword">int</span> width = view.getMeasuredWidth();  </div><div class="line">            <span class="keyword">int</span> height = view.getMeasuredHeight();  </div><div class="line">        &#125;  </div><div class="line">    &#125;;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>解决方法三：ViewTreeObserver</p>
</li>
<li><p>解决方法四：view.measure(int widthMeasureSpec， int heightMeasureSpec)<br>通过手动对View进行measure来得到View的宽高。这种方法比较复杂，这里要分情况处理，根据View的 LayoutParames 来分：<br><strong>match_parent：</strong><br>直接放弃，无法measure出具体的宽高。因为我们此时还没有办法知道父容器的剩余空间。<br><strong>具体的数值（dp/ps）：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 比如宽高都是100px  </span></div><div class="line"><span class="keyword">int</span> widthMeasureSpec = MeasureSpec.makeMeasureSpec(<span class="number">100</span>, MeasureSpec.EXACTLY);  </div><div class="line"><span class="keyword">int</span> heightMeasureSpec = MeasureSpec.makeMeasureSpec(<span class="number">100</span>,MeasureSpec.EXACTLY);  </div><div class="line">  </div><div class="line">view.measure(widthMeasureSpec, heightMeasureSpec);</div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>wrap_content：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> widthMeasureSpec = MeasureSpec.makeMeasureSpec( (<span class="number">1</span> &lt;&lt; <span class="number">30</span>) - <span class="number">1</span>, MeasureSpec.AT_MOST);  </div><div class="line"><span class="keyword">int</span> heightMeasureSpec = MeasureSpec.makeMeasureSpec( (<span class="number">1</span> &lt;&lt; <span class="number">30</span>) - <span class="number">1</span>,MeasureSpec.AT_MOST);  </div><div class="line">  </div><div class="line">view.measure(widthMeasureSpec, heightMeasureSpec);</div></pre></td></tr></table></figure></p>
<p>要知道的是(1 &lt;&lt; 30) - 1，VIew 的尺寸使用30位二进制表示，也就是说最大是30个1，也就是(1 &lt;&lt; 30) - 1。<br>在最大化模式下，我们使用View理论上能支持的最大值去构造MeasureSpec是合理的。</p>
<h2 id="常见Measure错误使用方法："><a href="#常见Measure错误使用方法：" class="headerlink" title="常见Measure错误使用方法："></a>常见Measure错误使用方法：</h2><p>无法通过错误的MeasureSpec去得出合法的SpecMode，从而导致measure过程出错，违背了系统内部的实现规范;其次不能保证一定能measure出正确结果。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> widthMeasureSpec = MeasureSpec.makeMeasureSpec( -<span class="number">1</span>, MeasureSpec.UNSPECIFIED);  </div><div class="line"><span class="keyword">int</span> heightMeasureSpec = MeasureSpec.makeMeasureSpec( -<span class="number">1</span>, MeasureSpec.UNSPECIFIED);  </div><div class="line">  </div><div class="line">view.measure(widthMeasureSpec, heightMeasureSpec);</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">view.measure(LayoutParames.WRAP_CONTENT, LayoutParames.WRAP_CONTENT);</div></pre></td></tr></table></figure>
<h1 id="View的layout过程"><a href="#View的layout过程" class="headerlink" title="View的layout过程"></a>View的layout过程</h1><ol>
<li>Layout的作用是ViewGroup用来确定子元素的位置，当ViewGroup的位置被确定后，它在 onLayout 中会遍历所有的子元素并调用其layout方法。<br>在layout方法中onLayout方法又会被调用。</li>
<li>layout方法会确定View本身的位置！！！！<br>而onLayout方法会确定所有子元素的位置！！！</li>
<li>先看View的layout方法：<br>源码位置：sources\android\view\View.java。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Assign a size and position to a view and all of its </div><div class="line"> * descendants </div><div class="line"> * </div><div class="line"> * &lt;p&gt;This is the second phase of the layout mechanism. </div><div class="line"> * (The first is measuring). In this phase, each parent calls </div><div class="line"> * layout on all of its children to position them. </div><div class="line"> * This is typically done using the child measurements </div><div class="line"> * that were stored in the measure pass().&lt;/p&gt; </div><div class="line"> * </div><div class="line"> * &lt;p&gt;Derived classes should not override this method. </div><div class="line"> * Derived classes with children should override </div><div class="line"> * onLayout. In that method, they should </div><div class="line"> * call layout on each of their children.&lt;/p&gt; </div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> l Left position, relative to parent </div><div class="line"> * <span class="doctag">@param</span> t Top position, relative to parent </div><div class="line"> * <span class="doctag">@param</span> r Right position, relative to parent </div><div class="line"> * <span class="doctag">@param</span> b Bottom position, relative to parent </div><div class="line"> */  </div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>&#125;)  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;  </div><div class="line">        onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);  </div><div class="line">        mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">int</span> oldL = mLeft;  </div><div class="line">    <span class="keyword">int</span> oldT = mTop;  </div><div class="line">    <span class="keyword">int</span> oldB = mBottom;  </div><div class="line">    <span class="keyword">int</span> oldR = mRight;  </div><div class="line">  </div><div class="line">    <span class="comment">/* </span></div><div class="line">     * 首先通过setFrame方法来设定View的四个顶点的位置， </div><div class="line">     * 即初始化mLeft、mTop、mBottom、mRight这四个值， </div><div class="line">     * 这四个顶点一旦被确定，那么View在父容器中的位置也就确定了 </div><div class="line">     * */  </div><div class="line">    <span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?  </div><div class="line">            setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;  </div><div class="line">        <span class="comment">/* </span></div><div class="line">         * 接着调用onLayout方法，这个方法的用途是父容器确定子元素的位置，和onMeasure方法类似。 </div><div class="line">         * onLayout的具体实现同样和具体的布局有关， </div><div class="line">         * 所以View和ViewGroup都没有真正实现onLayout方法。 </div><div class="line">         * */  </div><div class="line">        onLayout(changed, l, t, r, b);  </div><div class="line">        mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;  </div><div class="line">  </div><div class="line">        ListenerInfo li = mListenerInfo;  </div><div class="line">        <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;  </div><div class="line">            ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =  </div><div class="line">                    (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();  </div><div class="line">            <span class="keyword">int</span> numListeners = listenersCopy.size();  </div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;  </div><div class="line">                listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;  </div><div class="line">    mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>其中涉及到onLayout方法，我们看看View源码中是如何写的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Called from layout when this view should </div><div class="line"> * assign a size and position to each of its children. </div><div class="line"> * </div><div class="line"> * Derived classes with children should override </div><div class="line"> * this method and call layout on each of </div><div class="line"> * their children. </div><div class="line"> * <span class="doctag">@param</span> changed This is a new size or position for this view </div><div class="line"> * <span class="doctag">@param</span> left Left position, relative to parent </div><div class="line"> * <span class="doctag">@param</span> top Top position, relative to parent </div><div class="line"> * <span class="doctag">@param</span> right Right position, relative to parent </div><div class="line"> * <span class="doctag">@param</span> bottom Bottom position, relative to parent </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>什么也没有是吧！</p>
<ol>
<li>那就去看看LinearLayout的onLayout方法：<br>源码位置：sources\android\widget\LinearLayout.java。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (mOrientation == VERTICAL) &#123;  </div><div class="line">        layoutVertical(l, t, r, b);  </div><div class="line">    &#125; <span class="keyword">else</span> &#123;  </div><div class="line">        layoutHorizontal(l, t, r, b);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>同样的，分为垂直和水平两种情况。下面去看看layoutVertical好了。</p>
<ol>
<li>layoutVertical方法，只看有注释的地方就可以了：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Position the children during a layout pass if the orientation of this </div><div class="line"> * LinearLayout is set to &#123;<span class="doctag">@link</span> #VERTICAL&#125;. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@see</span> #getOrientation() </div><div class="line"> * <span class="doctag">@see</span> #setOrientation(int) </div><div class="line"> * <span class="doctag">@see</span> #onLayout(boolean, int, int, int, int) </div><div class="line"> * <span class="doctag">@param</span> left </div><div class="line"> * <span class="doctag">@param</span> top </div><div class="line"> * <span class="doctag">@param</span> right </div><div class="line"> * <span class="doctag">@param</span> bottom </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">layoutVertical</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;  </div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> paddingLeft = mPaddingLeft;  </div><div class="line">  </div><div class="line">    <span class="keyword">int</span> childTop;  </div><div class="line">    <span class="keyword">int</span> childLeft;  </div><div class="line">      </div><div class="line">    <span class="comment">// Where right end of child should go  </span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> width = right - left;  </div><div class="line">    <span class="keyword">int</span> childRight = width - mPaddingRight;  </div><div class="line">      </div><div class="line">    <span class="comment">// Space available for child  </span></div><div class="line">    <span class="keyword">int</span> childSpace = width - paddingLeft - mPaddingRight;  </div><div class="line">      </div><div class="line">    <span class="comment">// 获取子元素个数：  </span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getVirtualChildCount();  </div><div class="line">  </div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> majorGravity = mGravity &amp; Gravity.VERTICAL_GRAVITY_MASK;  </div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> minorGravity = mGravity &amp; Gravity.RELATIVE_HORIZONTAL_GRAVITY_MASK;  </div><div class="line">  </div><div class="line">    <span class="keyword">switch</span> (majorGravity) &#123;  </div><div class="line">       <span class="keyword">case</span> Gravity.BOTTOM:  </div><div class="line">           <span class="comment">// mTotalLength contains the padding already  </span></div><div class="line">           childTop = mPaddingTop + bottom - top - mTotalLength;  </div><div class="line">           <span class="keyword">break</span>;  </div><div class="line">  </div><div class="line">           <span class="comment">// mTotalLength contains the padding already  </span></div><div class="line">       <span class="keyword">case</span> Gravity.CENTER_VERTICAL:  </div><div class="line">           childTop = mPaddingTop + (bottom - top - mTotalLength) / <span class="number">2</span>;  </div><div class="line">           <span class="keyword">break</span>;  </div><div class="line">  </div><div class="line">       <span class="keyword">case</span> Gravity.TOP:  </div><div class="line">       <span class="keyword">default</span>:  </div><div class="line">           childTop = mPaddingTop;  </div><div class="line">           <span class="keyword">break</span>;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">/* </span></div><div class="line">     * 遍历所有的子元素，并调用setChildFrame： </div><div class="line">     * */  </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;  </div><div class="line">        <span class="keyword">final</span> View child = getVirtualChildAt(i);  </div><div class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;  </div><div class="line">            childTop += measureNullChild(i);  </div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;  </div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childWidth = child.getMeasuredWidth();  </div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();  </div><div class="line">              </div><div class="line">            <span class="keyword">final</span> LinearLayout.LayoutParams lp =  </div><div class="line">                    (LinearLayout.LayoutParams) child.getLayoutParams();  </div><div class="line">              </div><div class="line">            <span class="keyword">int</span> gravity = lp.gravity;  </div><div class="line">            <span class="keyword">if</span> (gravity &lt; <span class="number">0</span>) &#123;  </div><div class="line">                gravity = minorGravity;  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();  </div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);  </div><div class="line">            <span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;  </div><div class="line">                <span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:  </div><div class="line">                    childLeft = paddingLeft + ((childSpace - childWidth) / <span class="number">2</span>)  </div><div class="line">                            + lp.leftMargin - lp.rightMargin;  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">  </div><div class="line">                <span class="keyword">case</span> Gravity.RIGHT:  </div><div class="line">                    childLeft = childRight - childWidth - lp.rightMargin;  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">  </div><div class="line">                <span class="keyword">case</span> Gravity.LEFT:  </div><div class="line">                <span class="keyword">default</span>:  </div><div class="line">                    childLeft = paddingLeft + lp.leftMargin;  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            <span class="keyword">if</span> (hasDividerBeforeChildAt(i)) &#123;  </div><div class="line">                childTop += mDividerHeight;  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            childTop += lp.topMargin;  </div><div class="line">            <span class="comment">/* </span></div><div class="line">             * 在这里设置子元素的四个顶点值， </div><div class="line">             * 其中的childTop会不断增大， </div><div class="line">             * 这就意味着后面的子元素会被放置在靠下的位置， </div><div class="line">             * 这刚好符合竖直方向的LinearLayout的特性。 </div><div class="line">             * 但在setChildFrame中，其实它仅仅是调用了子元素的layout方法而已， </div><div class="line">             * */  </div><div class="line">            setChildFrame(child, childLeft, childTop + getLocationOffset(child),  </div><div class="line">                    childWidth, childHeight);  </div><div class="line">            childTop += childHeight + lp.bottomMargin + getNextLocationOffset(child);  </div><div class="line">  </div><div class="line">            i += getChildrenSkipCount(child, i);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>其中的setChildFrame方法是这样写的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setChildFrame</span><span class="params">(View child, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;          </div><div class="line">    child.layout(left, top, left + width, top + height);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还可以发现在setChildFrame中的width和height实际上就是子元素的测量宽高，就是在setChildFrame中的后两个参数是这样获取的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> childWidth = child.getMeasuredWidth();  </div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</div></pre></td></tr></table></figure></p>
<ol>
<li>这样父元素在layout方法中完成自己的定位以后，就通过onLayout方法去调用子元素的layout方法，子元素又会通过自己的layout方法来确定自己的位置，这样一层一层地传递下去就完成了整个View树的layout过程。</li>
<li>测量宽高和最终宽高之间的联系：<br>源码位置：sources\android\view\View.java。<br>getHeight获取的是最终高度：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Return the height of your view. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@return</span> The height of your view, in pixels. </div><div class="line"> */  </div><div class="line"><span class="meta">@ViewDebug</span>.ExportedProperty(category = <span class="string">"layout"</span>)  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> mBottom - mTop;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>getMeasuredHeight获取的是测量高度：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line"> * Like &#123;@link #getMeasuredHeightAndState()&#125;, but only returns the </div><div class="line"> * raw width component (that is the result is masked by </div><div class="line"> * &#123;@link #MEASURED_SIZE_MASK&#125;). </div><div class="line"> * </div><div class="line"> * @return The raw measured height of this view. </div><div class="line"> */  </div><div class="line">public final int getMeasuredHeight() &#123;  </div><div class="line">    return mMeasuredHeight &amp; MEASURED_SIZE_MASK;  </div><div class="line">&#125;  </div><div class="line">``` </div><div class="line"></div><div class="line">其实本质上来说他们两个是相同的，</div><div class="line">只是测量宽高形成于View的measure过程，而最终宽高形成于View的layout过程，即两者的赋值时机不同，测量宽高的赋值时机稍微早一些。</div><div class="line"></div><div class="line">ViewGroup需要负责子View显示的大小。当ViewGroup的大小为wrap_content时，ViewGroup就需要遍历子View，以便获得所有子View的大小，从而决定自己的大小。而在其他模式下则会通过具体的指定值来设置自身的大小。</div><div class="line">ViewGroup在测量时通过遍历所有子View，从而调用子View的Measure方法来获得每一个子View的测量结果。</div><div class="line">当子View测量完毕后，就需要将子View放到合适的位置，这个过程就是View 的Layout过程。ViewGroup在执行Layout过程时，同样是使用遍历来调用子View的Layout方法，并指定其具体显示的位置，从而来决定其布局位置。</div><div class="line">在自定义ViewGroup时，通常会去重写onLayout（）方法来控制其子View显示位置的逻辑。同样，如果需要支持wrap_content属性，那么它还必须重写onMeasure（）方法，这点与View是相同的。</div><div class="line"></div><div class="line"># View的绘制draw #</div><div class="line"></div><div class="line">1. 当测量好一个View之后，我们就可以简单的重写 onDraw（）方法，并在 Canvas 对象上来绘制所需要的图形。Canvas是onDraw（）方法的一个参数。</div><div class="line">要想在Android界面中绘制相应的图像，就必须在 Canvas 上进行绘制。 它就像一个画板，使用 Paint 就可以在上面作画了。</div><div class="line">2. 通常我们要在onDraw外创建一个Canvas对象，创建时还要引入布局中的一个bitmap对象：Canvas canvas = new Canvas(bitmap);  </div><div class="line">这里必须是一个bitmap对象，他与Canvas画布是紧紧联系在一起的，这个过程叫做 装载画布。</div><div class="line">3. bitmap用来存储所有绘制在 Canvas 上的像素信息，都是设置给bitmap的。</div><div class="line">举例：</div><div class="line">``` java</div><div class="line">//绘制两个bitmap：这两个是在onDraw中绘制的  </div><div class="line">canvas.drawBitmap(bitmap1,0,0,null);  </div><div class="line">canvas.drawBitmap(bitmap2.0,0,null);  </div><div class="line">// 现在将bitmap2装载到onDrow（）之外的Canvas对象中：  </div><div class="line">mCanvas = new Canvas(bitmap2);  </div><div class="line">// 然后通过mCanvas对bitmap2进行绘图：  </div><div class="line">mCanvas.drawXXX;</div></pre></td></tr></table></figure></p>
<p>这样通过mCanvas对bitmap2的绘制，刷新View后bitmap2就会发生相应的改变了。所以说所有的Canvas的绘制都是作用在bitmap上的，与在哪里，与哪个Canvas无关。</p>
<ol>
<li>Draw过程比较简单，它的作用是将View绘制到屏幕上面。</li>
<li>View的绘制过程遵循如下几步：<br>绘制背景 background.draw(canvas)<br>绘制自己 （onDraw）<br>绘制children （dispatchDraw）<br>绘制装饰 （onDrawScrollBars）</li>
<li><p>下面看看draw方法的源码：<br>源码位置：sources\android\view\View.java。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Manually render this view (and all of its children) to the given Canvas. </div><div class="line"> * The view must have already done a full layout before this function is </div><div class="line"> * called.  When implementing a view, implement </div><div class="line"> * &#123;<span class="doctag">@link</span> #onDraw(android.graphics.Canvas)&#125; instead of overriding this method. </div><div class="line"> * If you do need to override this method, call the superclass version. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> canvas The Canvas to which the View is rendered. </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (mClipBounds != <span class="keyword">null</span>) &#123;  </div><div class="line">        canvas.clipRect(mClipBounds);  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;  </div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;  </div><div class="line">            (mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);  </div><div class="line">    mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;  </div><div class="line">  </div><div class="line">    <span class="comment">/* </span></div><div class="line">     * Draw traversal performs several drawing steps which must be executed </div><div class="line">     * in the appropriate order: </div><div class="line">     * </div><div class="line">     *      1. Draw the background </div><div class="line">     *      2. If necessary, save the canvas' layers to prepare for fading </div><div class="line">     *      3. Draw view's content </div><div class="line">     *      4. Draw children </div><div class="line">     *      5. If necessary, draw the fading edges and restore layers </div><div class="line">     *      6. Draw decorations (scrollbars for instance) </div><div class="line">     */  </div><div class="line">  </div><div class="line">    <span class="comment">// Step 1, draw the background, if needed 绘制背景  </span></div><div class="line">    <span class="keyword">int</span> saveCount;  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (!dirtyOpaque) &#123;  </div><div class="line">        <span class="keyword">final</span> Drawable background = mBackground;  </div><div class="line">        <span class="keyword">if</span> (background != <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> scrollX = mScrollX;  </div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> scrollY = mScrollY;  </div><div class="line">  </div><div class="line">            <span class="keyword">if</span> (mBackgroundSizeChanged) &#123;  </div><div class="line">                background.setBounds(<span class="number">0</span>, <span class="number">0</span>,  mRight - mLeft, mBottom - mTop);  </div><div class="line">                mBackgroundSizeChanged = <span class="keyword">false</span>;  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            <span class="keyword">if</span> ((scrollX | scrollY) == <span class="number">0</span>) &#123;  </div><div class="line">                background.draw(canvas);  </div><div class="line">            &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                canvas.translate(scrollX, scrollY);  </div><div class="line">                background.draw(canvas);  </div><div class="line">                canvas.translate(-scrollX, -scrollY);  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">// skip step 2 &amp; 5 if possible (common case)  </span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;  </div><div class="line">    <span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;  </div><div class="line">    <span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;  </div><div class="line">    <span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;  </div><div class="line">        <span class="comment">// Step 3, draw the content 绘制自己  </span></div><div class="line">        <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);  </div><div class="line">  </div><div class="line">        <span class="comment">// Step 4, draw the children 绘制Children  </span></div><div class="line">        dispatchDraw(canvas);  </div><div class="line">  </div><div class="line">        <span class="comment">// Step 6, draw decorations (scrollbars) 绘制装饰  </span></div><div class="line">        onDrawScrollBars(canvas);  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;  </div><div class="line">            mOverlay.getOverlayView().dispatchDraw(canvas);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="comment">// we're done...  </span></div><div class="line">        <span class="keyword">return</span>;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在View.java中有dispatchDraw方法，但它是空的，其他的继承了View的比如说ViewGroup就要去重写这个方法去实现对子元素的绘制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Called by draw to draw the child views. This may be overridden </div><div class="line"> * by derived classes to gain control just before its children are drawn </div><div class="line"> * (but after its own view has been drawn). </div><div class="line"> * <span class="doctag">@param</span> canvas the canvas on which to draw the view </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;  </div><div class="line">  </div><div class="line">&#125; </div><div class="line">``` </div><div class="line"><span class="number">8</span>. ViewGroup通常不需要绘制，因为他本身就没有需要绘制的东西，如果不是指定了ViewGroup的背景颜色，那么ViewGroup的onDrow（）方法都不会被调用。</div><div class="line">但是，ViewGroup会使用dispatchDraw（）方法绘制其子View，其过程同样是遍历所有的子View，并调用子View的绘制方法来完成绘制工作。</div><div class="line">关于ViewGroup中dispatchDraw 方法的具体实现我们就在这里不列举了。</div><div class="line"><span class="number">9</span>. View中还有一个特殊的方法：setWillNotDraw：</div><div class="line">``` java</div><div class="line"><span class="comment">/** </span></div><div class="line"> * If this view doesn't do any drawing on its own, set this flag to </div><div class="line"> * allow further optimizations. By default, this flag is not set on </div><div class="line"> * View, but could be set on some View subclasses such as ViewGroup. </div><div class="line"> * </div><div class="line"> * Typically, if you override &#123;<span class="doctag">@link</span> #onDraw(android.graphics.Canvas)&#125; </div><div class="line"> * you should clear this flag. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> willNotDraw whether or not this View draw on its own </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWillNotDraw</span><span class="params">(<span class="keyword">boolean</span> willNotDraw)</span> </span>&#123;  </div><div class="line">    setFlags(willNotDraw ? WILL_NOT_DRAW : <span class="number">0</span>, DRAW_MASK);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>如果一个View不需要绘制任何内容，那么设置这个标记位为true以后，系统就会进行相应的优化。默认情况下，View并没有启用这个优化标记位，但是ViewGroup会默认启用这个优化标记位。<br>这个标记位对实际开发的意义是：当我们的自定义控件继承于ViewGroup并且本身不具备绘制功能时，就可以开启这个标记位从而便于系统进行后续的优化。<br>当然，当明确知道一个ViewGroup需要通过onDraw来绘制内容时，我们需要显式的关闭WILL_NOT_DRAW 这个标志位。</p>
<h1 id="自定义View"><a href="#自定义View" class="headerlink" title="自定义View"></a>自定义View</h1><p>在自定义View时，我们通常会去重写 onDraw（）方法来绘制View的显示内容，如果该View还需要使用wrap_content 属性，那么还必须重写 onMeasure（）方法。<br>另外，通过自定义 attrs属性，还可以设置新的属性配置值。</p>
<p>在View通常有以下一些比较重要的回调方法：</p>
<ol>
<li>onFinishInflate（）：从XML加载组件后回调。</li>
<li>onSizeChanged（）：组件大小改变时回调。</li>
<li>onMeasure（）：回调该方法来进行测量。</li>
<li>onLayout（）：回调该方法来确定显示的位置。</li>
<li>onTouchEvent（）：监听到触摸事件时回调。</li>
</ol>
<h2 id="自定义View的注意点："><a href="#自定义View的注意点：" class="headerlink" title="自定义View的注意点："></a>自定义View的注意点：</h2><ol>
<li><p>让View支持wrap_content：<br>如果直接继承View或者ViewGroup的控件，如果不在onMeasure中对wrap_content做特殊处理，那么当外界在布局中使用wrap_content时，就无法达到预期的效果。</p>
</li>
<li><p>如果有必要，让你的View支持padding：<br>如果直接继承View，如果不再draw方法中处理padding，那么padding属性是无法起到作用的。<br>另外，直接继承子ViewGroup的控件需要在onMeasure和onLayout中考虑padding和子元素的margin对其造成的影响，不然将导致padding和子元素margin失效。</p>
</li>
<li><p>尽量不要在View中使用Handler，没必要：<br>因为View内部本身就提供了post系列的方法，完全可以替代Handler的作用，<br>当然除非你很明确要使用Handler来发送消息。</p>
</li>
<li><p>View中如果有线程或者动画，需要及时停止，参考View#onDetachedFromWindow：<br>如果有动画或者线程需要停止时，那么onDetachedFromWindow是一个很好的时机。<br>当包含此View的Activity退出或者当前View被remove时，View的onDetachedFromWindow方法会被调用，<br>和onDetachedFromWindow方法对应的是onAttachedToWindow，<br>当包含此View的Activity启动时，View的onAttachedToWindow方法会被调用。<br>同时当View变得不可见时，我们也要停止线程和动画，<br>如果不及时处理这种问题，有可能会造成内存泄漏！！！！</p>
</li>
<li><p>View带有滑动嵌套情形时，需要处理好滑动冲突：<br>没什么好解释的了。</p>
</li>
</ol>
<h2 id="自定义View的分类："><a href="#自定义View的分类：" class="headerlink" title="自定义View的分类："></a>自定义View的分类：</h2><ol>
<li><p>继承特定的View，比如TextView：（对现有控件进行拓展）<br>用于扩展已有的View的功能。<br>这种方法不需要自己支持wrap_content和padding等。</p>
</li>
<li><p>继承View重新onDraw方法：（重写View来实现全新的控件）<br>主要用于实现一些不规则的效果，比如绘制一个圆啊，方框啊什么的。<br>采用这种方式需要自己支持wrap_content，并且padding需要自己处理。</p>
</li>
<li><p>继承特定的ViewGroup，比如LinearLayout：（创建复合控件）<br>不需要处理ViewGroup的测量和布局。</p>
</li>
<li><p>继承ViewGroup派生特殊的Layout：（自定义ViewGroup）<br>用于实现自定义布局，即除了LinearLayout、RelativeLayout、FrameLayout这几种系统的布局之外，我们重新定义一种新的布局。<br>当某种效果看起来很像几种View组合在一起的时候，可以采用这种方法来实现。<br>这种方式需要合适地处理 ViewGroup的测量、布局这两个过程，并同时处理子元素的测量和布局过程。</p>
</li>
</ol>
<h2 id="对现有控件进行拓展："><a href="#对现有控件进行拓展：" class="headerlink" title="对现有控件进行拓展："></a>对现有控件进行拓展：</h2><p>一般来说，在onDraw（）方法中对原生控件行为进行拓展。</p>
<p>举例1：让一个TextView的背景更加丰富，给其多绘制几层背景：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line"> * 初始化画笔等 </div><div class="line"> */  </div><div class="line">private void initPaint() &#123;  </div><div class="line">    // 蓝色线条  </div><div class="line">    paint1 = new Paint();  </div><div class="line">    paint1.setColor(getResources().getColor(  </div><div class="line">            android.R.color.holo_blue_bright));  </div><div class="line">    paint1.setStyle(Paint.Style.FILL);  </div><div class="line">    // 绿色背景  </div><div class="line">    paint2 = new Paint();  </div><div class="line">    paint2.setColor(getResources()  </div><div class="line">            .getColor(android.R.color.holo_green_dark));  </div><div class="line">    paint2.setStyle(Paint.Style.FILL);  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">/** </div><div class="line"> * 我们可以在在调用super.onDraw(canvas)之前和之后实现自己的逻辑， </div><div class="line"> * 分别在系统绘制文字前后，完成自己的操作 </div><div class="line"> */  </div><div class="line">@Override  </div><div class="line">protected void onDraw(Canvas canvas) &#123;  </div><div class="line">      </div><div class="line">    // TODO 回调父类方法super.onDraw(canvas)前，对TextView来说即是绘制文本内容之前  </div><div class="line">    /* </div><div class="line">     * 在绘制文字之下，绘制两个大小不同的矩形，形成一个重叠的效果， </div><div class="line">     * 再让系统调用super.onDraw方法，执行绘制文字的工作。 </div><div class="line">     * */  </div><div class="line">    // 绘制一个外层矩形，蓝色那个  </div><div class="line">    canvas.drawRect(  </div><div class="line">            0,   </div><div class="line">            0,   </div><div class="line">            getMeasuredWidth(),   </div><div class="line">            getMeasuredHeight(),   </div><div class="line">            paint1);  </div><div class="line">    // 绘制一个内层矩形，绿色那个  </div><div class="line">    canvas.drawRect(  </div><div class="line">            10,   </div><div class="line">            10,   </div><div class="line">            getMeasuredWidth() - 10,  </div><div class="line">            getMeasuredHeight() - 10,   </div><div class="line">            paint2);  </div><div class="line">    canvas.save();  </div><div class="line">    // 绘制文字前平移10px  </div><div class="line">    canvas.translate(10, 0);  </div><div class="line">      </div><div class="line">    super.onDraw(canvas);  </div><div class="line">      </div><div class="line">    // TODO 回调父类方法后，对TextView来说即是绘制文本内容之后  </div><div class="line">    canvas.restore();  </div><div class="line">      </div><div class="line">&#125;  </div><div class="line">``` </div><div class="line">举例2：闪动的文字效果</div><div class="line">要想实现这个效果，要充分利用Android中Paint对象的Shader渲染器。通过设置一个不断变化的 LinearGradient，并使用带有该属性的Paint对象来绘制要显示的文字。</div><div class="line">首先，在onSizeChanged(),中进行一些对象的初始化工作，根据view的宽设置一个LinearGradient渐变渲染器。</div><div class="line">``` java</div><div class="line">private int mViewWidth;  </div><div class="line">private Paint mPaint;  </div><div class="line">private Linear Gradient linearGradient;  </div><div class="line">private Matrix matrix;  </div><div class="line">private int mTranslate;  </div><div class="line">  </div><div class="line">  </div><div class="line">@Override  </div><div class="line">protected void onSizeChanged(int w, int h, int oldw, int oldh) &#123;  </div><div class="line">&lt;span style="white-space:pre"&gt;    &lt;/span&gt;  </div><div class="line">    super.onSizeChanged(w, h, oldw, oldh);  </div><div class="line">      </div><div class="line">    if(mViewWidth==0)&#123;  </div><div class="line">        mViewWidth = getMeasuredWidth();//系统里的函数  </div><div class="line">          </div><div class="line">        if(mViewWidth&gt;0)&#123;  </div><div class="line">        &lt;span style="white-space:pre"&gt;    &lt;/span&gt;// 获取当前绘制TextView的Paint对象  </div><div class="line">        &lt;span style="white-space:pre"&gt;    &lt;/span&gt;mPaint = getPaint();  </div><div class="line">            // 给这个paint对象设置原生TextView没有的LinearGradient属性：  </div><div class="line">            linearGradient = new LinearGradient(  </div><div class="line">            0,   </div><div class="line">            0,   </div><div class="line">            mViewWidth,   </div><div class="line">            0,   </div><div class="line">                    new int[]&#123;Color.BLUE,0xffffffff,Color.GREEN&#125;,   </div><div class="line">                    new float[]&#123;0,1,2&#125;,   </div><div class="line">                    Shader.TileMode.MIRROR);  </div><div class="line">            paint.setShader(linearGradient);  </div><div class="line">            matrix = new Matrix();  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">  </div><div class="line">/** </div><div class="line"> * 在onDraw中通过矩阵的方式来不断平移渐变效果，从而在绘制文字时，产生动态的闪动的效果： </div><div class="line"> */  </div><div class="line">@Override  </div><div class="line">protected void onDraw(Canvas canvas) &#123;  </div><div class="line">  </div><div class="line">  </div><div class="line">// TODO 回调父类方法super.onDraw(canvas)前，对TextView来说即是绘制文本内容之前  </div><div class="line">super.onDraw(canvas);  </div><div class="line">// TODO 回调父类方法后，对TextView来说即是绘制文本内容之后  </div><div class="line">Log.e("mess", "------onDraw----");  </div><div class="line">if (matrix != null) &#123;  </div><div class="line">    mTranslate += mViewWidth / 5;  </div><div class="line">    if (mTranslate &gt; 2 * mViewWidth) &#123;  </div><div class="line">    mTranslate = -mViewWidth;  </div><div class="line">    &#125;  </div><div class="line">    matrix.setTranslate(mTranslate, 0);  </div><div class="line">    linearGradient.setLocalMatrix(matrix);  </div><div class="line">    postInvalidateDelayed(100);  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个例子需要注意的地方是在onSizeChanged方法中，mPaint = getPaint();<br>这是什么意思呢，在第一个例子中，我们的Paint都是在程序中创建的新的，而这个例子中是同个getPaint（）方法获取的。<br>也就是说，第一个例子中创建的Paint是要画在已有的TextView上的，<br>而第二个例子中我们获取了TextView它本身自己的Paint，然后在它的基础上进行修改，<br>这样就可以将效果加载在TextView本身的文字上了。<br>至于后面的那个matrix我确实没有理解。还没有用过。</p>
<h2 id="创建复合控件"><a href="#创建复合控件" class="headerlink" title="创建复合控件"></a>创建复合控件</h2><p>这种方式通常需要继承一个已有的ViewGroup，再给它添加指定功能的控件，从而组合成新的复合控件。<br>复合控件，最常见的其实就是我们的TitleBar了，一般就是一个left+title+right组合。</p>
<ol>
<li>定义属性：<br>为一个View提供可自定义的属性非常简单，只需要在res资源目录的values目录下创建一个attrs.xml的属性定义文件，并在该文件中通过如下代码定义相应的属性即可：<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;  </div><div class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span>  </div><div class="line">        <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"TitleBar"</span>&gt;</span>  </div><div class="line">            <span class="comment">&lt;!-- 定义title文字，大小，颜色 --&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"title"</span> <span class="attr">format</span>=<span class="string">"string"</span> /&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"titleTextSize"</span> <span class="attr">format</span>=<span class="string">"dimension"</span>/&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"titleTextColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span>  </div><div class="line">            <span class="comment">&lt;!-- 定义left 文字，大小，颜色，背景 --&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"leftText"</span> <span class="attr">format</span>=<span class="string">"string"</span> /&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"leftTextSize"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"leftTextColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span>  </div><div class="line">            <span class="comment">&lt;!-- 表示背景可以是颜色，也可以是引用 --&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"leftBackGround"</span> <span class="attr">format</span>=<span class="string">"color|reference"</span> /&gt;</span>  </div><div class="line">            <span class="comment">&lt;!-- 定义right 文字，大小，颜色，背景 --&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"rightText"</span> <span class="attr">format</span>=<span class="string">"string"</span> /&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"rightTextSize"</span> <span class="attr">format</span>=<span class="string">"dimension"</span>/&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"rightTextColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"rightBackGround"</span> <span class="attr">format</span>=<span class="string">"color|reference"</span> /&gt;</span>  </div><div class="line">        <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>下面需要创建一个类，叫TitleBar，并且它继承自RelativeLayout中。在这个类中：</p>
<ol>
<li><p>获取自定义属性集<br>TypedArray typed = context.obtainStyledAttributes(attrs, R.styleable.TitleBar);<br>系统提供了 TypedArray 这样的数据结构来获取自定义属性集，后面引用的 styleable 的TitleBar ，就是我们在XML中通过<declare-styleable name="TitleBar">所指定的name名。接下来通过TypedArray对象的getString（）、getColor（）等方法，就可以获取这些定义的属性值：</declare-styleable></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line">   * 获取自定义的属性 </div><div class="line">   *  </div><div class="line">   * <span class="doctag">@param</span> context </div><div class="line">   */  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> leftTextColor;  </div><div class="line">  <span class="keyword">private</span> Drawable leftBackGround;  </div><div class="line">  <span class="keyword">private</span> String leftText;  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">float</span> leftTextSize;  </div><div class="line">  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> rightTextColor;  </div><div class="line">  <span class="keyword">private</span> String rightText;  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">float</span> rightTextSize;  </div><div class="line">  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> titleTextColor;  </div><div class="line">  <span class="keyword">private</span> String titleText;  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">float</span> titleTextSize;  </div><div class="line">  </div><div class="line">  <span class="comment">/** </span></div><div class="line">   * 通过这个方法，将你在attrs.xml中定义的 declare_styleable的 </div><div class="line">   * 所有属性的值存储到TypedArray中： </div><div class="line">   * <span class="doctag">@param</span> context </div><div class="line">   * <span class="doctag">@param</span> attrs </div><div class="line">   */  </div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initAttr</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="comment">// 得到TypedArray对象typed  </span></div><div class="line">      TypedArray typed = context.obtainStyledAttributes(attrs, R.styleable.TitleBar);  </div><div class="line">        </div><div class="line">      <span class="comment">// 从typed中取出对应的值为要设置的属性赋值，第二个参数是未指定时的默认值  </span></div><div class="line">      <span class="comment">// 这里第一个参数是 R.styleable.name_attrname 耶  </span></div><div class="line">      leftTextColor = typed.getColor(R.styleable.TitleBar_leftTextColor, <span class="number">0XFFFFFFFF</span>);  </div><div class="line">      leftBackGround = typed.getDrawable(R.styleable.TitleBar_leftBackGround);  </div><div class="line">      leftText = typed.getString(R.styleable.TitleBar_leftText);  </div><div class="line">      leftTextSize = typed.getDimension(R.styleable.TitleBar_leftTextSize, <span class="number">20</span>);  </div><div class="line">  </div><div class="line">      rightTextColor = typed.getColor(R.styleable.TitleBar_rightTextColor, <span class="number">0XFFFFFFFF</span>);  </div><div class="line">      rightText = typed.getString(R.styleable.TitleBar_rightText);  </div><div class="line">      rightTextSize = typed.getDimension(R.styleable.TitleBar_rightTextSize, <span class="number">20</span>);  </div><div class="line">  </div><div class="line">      titleTextColor = typed.getColor(R.styleable.TitleBar_titleTextColor, <span class="number">0XFFFFFFFF</span>);  </div><div class="line">      titleText = typed.getString(R.styleable.TitleBar_title);  </div><div class="line">      titleTextSize = typed.getDimension(R.styleable.TitleBar_titleTextSize, <span class="number">20</span>);  </div><div class="line">        </div><div class="line">      <span class="comment">// 不要忘记调用,用来避免重新创建的时候的错误。  </span></div><div class="line">      typed.recycle();  </div><div class="line">  </div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>组合控件（在UI模板类中）<br>UI模版TitleBar实际上由三个控件组成，即左边的点击按钮mLeftButton，右边的点击按钮mRightButton和中间的标题栏mTitleView。通过动态添加控件的方式，使用addView方法将这三个控件加入到定义的TitleBar模版中，并给它们设置我们前面所获取到的具体的属性值，比如标题的文字颜色、大小等：<br>这里要注意啦，下面的各种setXXX中，括号里都是刚刚上面initAttr中获取的值。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line">private TextView titleView;  </div><div class="line">private Button leftButton;  </div><div class="line">private Button rightButton;  </div><div class="line">  </div><div class="line">  </div><div class="line">private RelativeLayout.LayoutParams leftParams;  </div><div class="line">private RelativeLayout.LayoutParams rightParams;  </div><div class="line">private RelativeLayout.LayoutParams titleParams;  </div><div class="line">  </div><div class="line">  </div><div class="line">/** </div><div class="line"> * 代码布局 </div><div class="line"> *  </div><div class="line"> * @param context </div><div class="line"> */  </div><div class="line">@SuppressWarnings("deprecation")  </div><div class="line">private void initView(Context context) &#123;  </div><div class="line">&lt;span style="white-space:pre"&gt;    &lt;/span&gt;// TitleBar上的三个控件  </div><div class="line">    titleView = new TextView(context);  </div><div class="line">    leftButton = new Button(context);  </div><div class="line">    rightButton = new Button(context);  </div><div class="line">  </div><div class="line">  </div><div class="line">    // 为创建的组件赋值，标题栏  </div><div class="line">    titleView.setText(titleText);  </div><div class="line">    titleView.setTextSize(titleTextSize);  </div><div class="line">    titleView.setTextColor(titleTextColor);  </div><div class="line">    titleView.setGravity(Gravity.CENTER);  </div><div class="line">  </div><div class="line">  </div><div class="line">    // 为创建的组件赋值，左边按钮  </div><div class="line">    leftButton.setText(leftText);  </div><div class="line">    leftButton.setTextColor(leftTextColor);  </div><div class="line">    leftButton.setBackgroundDrawable(leftBackGround);  </div><div class="line">    leftButton.setTextSize(leftTextSize);  </div><div class="line">  </div><div class="line">  </div><div class="line">    // 为创建的组件赋值，右边按钮  </div><div class="line">    rightButton.setText(rightText);  </div><div class="line">    rightButton.setTextSize(rightTextSize);  </div><div class="line">    rightButton.setTextColor(rightTextColor);  </div><div class="line">  </div><div class="line">  </div><div class="line">    // 为组件元素设置相应的布局元素，设置大小和位置  </div><div class="line">    // 在左边  </div><div class="line">    leftParams = new LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.MATCH_PARENT);  </div><div class="line">    leftParams.addRule(RelativeLayout.ALIGN_PARENT_LEFT, RelativeLayout.TRUE);  </div><div class="line">    // 添加到ViewGroup中：  </div><div class="line">    addView(leftButton, leftParams);  </div><div class="line">  </div><div class="line">  </div><div class="line">    // 在右边  </div><div class="line">    rightParams = new LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.MATCH_PARENT);  </div><div class="line">    rightParams.addRule(RelativeLayout.ALIGN_PARENT_RIGHT, RelativeLayout.TRUE);  </div><div class="line">    addView(rightButton, rightParams);  </div><div class="line">  </div><div class="line">  </div><div class="line">    //中间  </div><div class="line">    titleParams = new LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.MATCH_PARENT);  </div><div class="line">    rightParams.addRule(RelativeLayout.CENTER_IN_PARENT, RelativeLayout.TRUE);  </div><div class="line">    addView(titleView, titleParams);  </div><div class="line">  </div><div class="line">  </div><div class="line">    //添加点击监听，（下面讲述如何引入的）  </div><div class="line">    /* </div><div class="line">     * 这里的setOnClickListener是系统的关于一个Button的自带的点击事件 </div><div class="line">     * */  </div><div class="line">    leftButton.setOnClickListener(new OnClickListener() &#123;  </div><div class="line">  </div><div class="line">  </div><div class="line">        @Override  </div><div class="line">        public void onClick(View v) &#123;  </div><div class="line">        /* </div><div class="line">         * 在对点击事件做相应以前，在调用这的MainActivity中，就已经把listenr传入进来了， </div><div class="line">         * 在这里只需要直接调用就可以了。 </div><div class="line">         * 其中listener是一个setTitleBarClickListener接口方法的对象。 </div><div class="line">         * */  </div><div class="line">            if (listener != null) &#123;  </div><div class="line">            //正常设置它们的点击事件处理onClick，只是在onClick中让它们执行我们设定的处理。  </div><div class="line">                listener.leftClick();  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;);  </div><div class="line">  </div><div class="line">  </div><div class="line">    rightButton.setOnClickListener(new OnClickListener() &#123;  </div><div class="line">  </div><div class="line">  </div><div class="line">        @Override  </div><div class="line">        public void onClick(View v) &#123;  </div><div class="line">            if (listener != null) &#123;  </div><div class="line">                listener.rightClick();  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;);  </div><div class="line">  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>定义接口（在UI模板类中）<br>那么如何给这两个左右按钮设计点击事件呢？既然是UI模版，那么每个调用者所需要这些按钮能够实现的功能都是不一样的，因此，不能直接在UI模板中添加具体的实现逻辑，只能通过接口回调的思想，将具体的实现逻辑交给调用者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* </span></div><div class="line"> * 这是一个接口方法，这个接口中有两个为实现的方法。 </div><div class="line"> * */  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TitleBarClickListener</span></span>&#123;  </div><div class="line">    <span class="comment">//左点击  </span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">leftClick</span><span class="params">()</span></span>;  </div><div class="line">    <span class="comment">//右点击  </span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rightClick</span><span class="params">()</span></span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>也就是模板类中的这两个方法需要在具体的调用者的代码中实现。</p>
<ol>
<li><p>暴露接口给调用者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * 暴露一个方法给调用者来注册接口回调，通过接口来获得回调者对接口方法TitleBarClickListener的实现 </div><div class="line"> * 这里的参数是一个TitleBarClickListener接口的接口对象。 </div><div class="line"> * <span class="doctag">@param</span> listener </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitleBarClickListener</span><span class="params">(TitleBarClickListener listener)</span> </span>&#123;  </div><div class="line">    <span class="keyword">this</span>.listener = listener;  </div><div class="line">&#125; </div><div class="line">``` </div><div class="line">还包括上面（<span class="number">3</span>）中的两个调用呢</div><div class="line"></div><div class="line"><span class="number">5</span>. 实现接口的回调</div><div class="line">就是说在调用者MainActivity的代码中重写接口中的leftClick（）方法和rightClick（）方法来实现具体的逻辑：</div><div class="line">``` java</div><div class="line"><span class="comment">/** </span></div><div class="line"> * 在调用者的代码中，调用者需要实现这样的一个接口，并完成接口中的方法，确定具体的实现逻辑 </div><div class="line"> * 并使用刚刚暴露的方法，将接口的对象传递进去，从而完成回调。 </div><div class="line"> * 通常情况下，可以使用匿名内部类的形式来实现接口中的方法： </div><div class="line"> */  </div><div class="line"><span class="keyword">private</span> TitleBar titlebar;  </div><div class="line">  </div><div class="line">  </div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;  </div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);  </div><div class="line">    setContentView(R.layout.activity_main);  </div><div class="line">    titlebar = (TitleBar) findViewById(R.id.titlebar);  </div><div class="line">    <span class="comment">/* </span></div><div class="line">     * setTitleBarClickListener是在TitleBar定义中的一个方法，它用来接收listener。 </div><div class="line">     * TitleBarClickListener是在TitleBar中定义的一个接口， </div><div class="line">     * 这个接口中有两个为实现的方法rightClick和leftClick。 </div><div class="line">     * 这里重写了leftClick和rightClick方法。 </div><div class="line">     * */  </div><div class="line">    titlebar.setTitleBarClickListener(<span class="keyword">new</span> TitleBar.TitleBarClickListener()&#123;  </div><div class="line">      </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rightClick</span><span class="params">()</span></span>&#123;  </div><div class="line">    Toast.makeText(<span class="keyword">this</span>, <span class="string">"right---"</span>, Toast.LENGTH_LONG).show();  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">leftClick</span><span class="params">()</span></span>&#123;  </div><div class="line">    Toast.makeText(<span class="keyword">this</span>, <span class="string">"left---"</span>, Toast.LENGTH_LONG).show();  </div><div class="line">    &#125;  </div><div class="line">    &#125;);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>引用UI模板<br>在引用前，都需要指定第三方控件的名字空间：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xmlns：android="http://schemas.android.com/apk/res/android"</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这行代码就是在指定引用的名字控件xmlns，即xml namespace。这里指定了名字控件为“android”，因此在接下来使用系统属性的时候，才可以使用“android：”来引用Android的系统属性。<br>那么如果需要使用自己自定义的属性，那么就需要创建自己的名字空间，在Android Studio中，第三方的控件都使用如下的代码来引入名字空间：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">xmlns：android="http://schemas.android.com/apk/res-auto" </div><div class="line">``` </div><div class="line">其中android是我们的名字空间，这个是可以自己改的，自己设置的，比如可以起名称叫cumtom什么的。</div><div class="line">使用自定义的VIew与系统原生的View最大的区别就是在申明控件时，需要指定完整的包名，而在引用自定义的属性时，需要使用自定义的xmlns名字：</div><div class="line">``` html</div><div class="line"><span class="tag">&lt;<span class="name">com.example.day_1.TitleBar</span> <span class="attr">xmlns</span>：<span class="attr">android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>  </span></div><div class="line"><span class="attr">xmlns</span>：<span class="attr">custom</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span>  </div><div class="line"><span class="attr">android:id</span>=<span class="string">"@+id/titlebar"</span>  </div><div class="line"><span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span>  </div><div class="line"><span class="attr">android:layout_height</span>=<span class="string">"100dp"</span>  </div><div class="line"><span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span>  </div><div class="line"><span class="attr">custom:leftBackGround</span>=<span class="string">"#ff000000"</span>  </div><div class="line"><span class="attr">custom:leftText</span>=<span class="string">"left"</span>  </div><div class="line"><span class="attr">custom:leftTextColor</span>=<span class="string">"#ffff6734"</span>  </div><div class="line"><span class="attr">custom:leftTextSize</span>=<span class="string">"25dp"</span>   </div><div class="line"><span class="attr">custom:rightText</span>=<span class="string">"right"</span>  </div><div class="line"><span class="attr">custom:rightTextSize</span>=<span class="string">"25dp"</span>  </div><div class="line"><span class="attr">custom:rightTextColor</span>=<span class="string">"#ff123456"</span>  </div><div class="line"><span class="attr">custom:title</span>=<span class="string">"title"</span>  </div><div class="line"><span class="attr">custom:titleTextColor</span>=<span class="string">"#ff654321"</span>/&gt;  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">com.example.day_1.TitleBar</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>再更进一步，我们也可以将UI模板写到一个布局文件TitleBar.xml中：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">com.example.day_1.TitleBar</span> <span class="attr">xmlns</span>：<span class="attr">android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>  </span></div><div class="line">    <span class="attr">xmlns</span>：<span class="attr">app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span>  </div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/titlebar"</span>  </div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span>  </div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span>  </div><div class="line">    <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span>  </div><div class="line">    <span class="attr">app:leftBackGround</span>=<span class="string">"#ff000000"</span>  </div><div class="line">    <span class="attr">app:leftText</span>=<span class="string">"left"</span>  </div><div class="line">    <span class="attr">app:leftTextColor</span>=<span class="string">"#ffff6734"</span>  </div><div class="line">    <span class="attr">app:leftTextSize</span>=<span class="string">"25dp"</span>   </div><div class="line">    <span class="attr">app:rightText</span>=<span class="string">"right"</span>  </div><div class="line">    <span class="attr">app:rightTextSize</span>=<span class="string">"25dp"</span>  </div><div class="line">    <span class="attr">app:rightTextColor</span>=<span class="string">"#ff123456"</span>  </div><div class="line">    <span class="attr">app:title</span>=<span class="string">"title"</span>  </div><div class="line">    <span class="attr">app:titleTextColor</span>=<span class="string">"#ff654321"</span>/&gt;  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">com.example.day_1.TitleBar</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>通过上面的代码，我们就可以在其他的局部文件中，通过<include>标签来引用这个UI模板View：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/TitleBar"</span>&gt;</span></div></pre></td></tr></table></figure></include></p>
<h2 id="重写VIew来实现全新的控件"><a href="#重写VIew来实现全新的控件" class="headerlink" title="重写VIew来实现全新的控件"></a>重写VIew来实现全新的控件</h2><p>创建自定义View的难点在于绘制控件和实现交互。<br>通常需要继承View类，并重写它的 onDraw（）、onMeasure（）等方法来实现绘制逻辑，<br>同时通过重写 onTouchEvent（）等触控事件来实现交互逻辑。<br>我们还可以像实现控件方式那样，通过引入自定义属性，丰富自定义View的可定制性。</p>
<h3 id="例1：弧线展示图"><a href="#例1：弧线展示图" class="headerlink" title="例1：弧线展示图"></a>例1：弧线展示图</h3><p><img src="http://7xu1cb.com1.z0.glb.clouddn.com/%E5%BC%A7%E7%BA%BF%E5%B1%95%E7%A4%BA%E5%9B%BE.png" alt="弧线展示图"></p>
<p>思路：这个view可以分为三个部分，中间的圆圈，中间显示的文字，外圈的圆弧。只要有了这样的思路，剩余的就是在onDraw()方法中去绘制了。</p>
<p>首先我们这个自定义的View名叫CirclePregressView。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mMeasureHeigth;<span class="comment">// 控件高度  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mMeasureWidth;<span class="comment">// 控件宽度  </span></div><div class="line"><span class="comment">// 圆形  </span></div><div class="line"><span class="keyword">private</span> Paint mCirclePaint;  </div><div class="line"><span class="keyword">private</span> <span class="keyword">float</span> mCircleXY;<span class="comment">//圆心坐标  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">float</span> mRadius;<span class="comment">//圆形半径  </span></div><div class="line"><span class="comment">// 圆弧  </span></div><div class="line"><span class="keyword">private</span> Paint mArcPaint;  </div><div class="line"><span class="keyword">private</span> RectF mArcRectF;<span class="comment">//圆弧的外切矩形  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">float</span> mSweepAngle;<span class="comment">//圆弧的角度  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">float</span> mSweepValue = <span class="number">50</span>;<span class="comment">// 用来计算圆弧的角度  </span></div><div class="line"><span class="comment">// 文字  </span></div><div class="line"><span class="keyword">private</span> Paint mTextPaint;  </div><div class="line"><span class="keyword">private</span> String mShowText;<span class="comment">//文本内容  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">float</span> mShowTextSize;<span class="comment">//文本大小  </span></div><div class="line">  </div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line"><span class="comment">//获取控件宽度  </span></div><div class="line">    mMeasureWidth = MeasureSpec.getSize(widthMeasureSpec);  </div><div class="line">    <span class="comment">//获取控件高度  </span></div><div class="line">    mMeasureHeigth = MeasureSpec.getSize(heightMeasureSpec);  </div><div class="line">    <span class="comment">// 设置大小  </span></div><div class="line">    setMeasuredDimension(mMeasureWidth, mMeasureHeigth);  </div><div class="line">    initView();  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">/** </span></div><div class="line"> *准备画笔， </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line"><span class="comment">// View的长度为宽高的最小值：  </span></div><div class="line">    <span class="keyword">float</span> length = Math.min(mMeasureWidth,mMeasureHeigth);  </div><div class="line">      </div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 圆 </div><div class="line">     */  </div><div class="line">    <span class="comment">// 确定圆心坐标  </span></div><div class="line">    mCircleXY = length / <span class="number">2</span>;  </div><div class="line">    <span class="comment">// 确定圆的半径  </span></div><div class="line">    mRadius = (<span class="keyword">float</span>) (length * <span class="number">0.5</span> / <span class="number">2</span>);  </div><div class="line">    <span class="comment">// 定义画笔  </span></div><div class="line">    mCirclePaint = <span class="keyword">new</span> Paint();  </div><div class="line">    <span class="comment">// 去锯齿  </span></div><div class="line">    mCirclePaint.setAntiAlias(<span class="keyword">true</span>);  </div><div class="line">    <span class="comment">// 设置颜色  </span></div><div class="line">    mCirclePaint.setColor(getResources().getColor(android.R.color.holo_green_dark));  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 圆弧 </div><div class="line">     */  </div><div class="line">    <span class="comment">// 圆弧的外切矩形  </span></div><div class="line">    mArcRectF = <span class="keyword">new</span> RectF(  </div><div class="line">          (<span class="keyword">float</span>) (length * <span class="number">0.1</span>),   </div><div class="line">          (<span class="keyword">float</span>) (length * <span class="number">0.1</span>),   </div><div class="line">          (<span class="keyword">float</span>) (length * <span class="number">0.9</span>),  </div><div class="line">          (<span class="keyword">float</span>) (length * <span class="number">0.9</span>));  </div><div class="line">    <span class="comment">// 圆弧的角度  </span></div><div class="line">    mSweepAngle = (mSweepValue / <span class="number">100f</span>) * <span class="number">360f</span>;  </div><div class="line">    <span class="comment">// 圆弧画笔  </span></div><div class="line">    mArcPaint = <span class="keyword">new</span> Paint();  </div><div class="line">    <span class="comment">// 设置颜色  </span></div><div class="line">    mArcPaint.setColor(getResources().getColor(android.R.color.holo_blue_bright));  </div><div class="line">    <span class="comment">//圆弧宽度  </span></div><div class="line">    mArcPaint.setStrokeWidth((<span class="keyword">float</span>) (length * <span class="number">0.1</span>));  </div><div class="line">    <span class="comment">//圆弧  </span></div><div class="line">    mArcPaint.setStyle(Style.STROKE);  </div><div class="line">      </div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 文字 </div><div class="line">     */  </div><div class="line">    mShowText = setShowText();  </div><div class="line">    mShowTextSize = setShowTextSize();  </div><div class="line">    mTextPaint = <span class="keyword">new</span> Paint();  </div><div class="line">    mTextPaint.setTextSize(mShowTextSize);  </div><div class="line">    mTextPaint.setTextAlign(Paint.Align.CENTER);  </div><div class="line">  </div><div class="line">  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">/** </span></div><div class="line"> * 设置文字内容 </div><div class="line"> * <span class="doctag">@return</span> </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">setShowText</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">this</span>.invalidate();  </div><div class="line">    <span class="keyword">return</span> <span class="string">"Android Skill"</span>;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">/** </span></div><div class="line"> * 设置文字大小 </div><div class="line"> * <span class="doctag">@return</span> </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">setShowTextSize</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">this</span>.invalidate();  </div><div class="line">    <span class="keyword">return</span> <span class="number">50</span>;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">/** </span></div><div class="line"> * 这个函数还不能缺少，至于invalidate的使用方法，我现在还不知道呢 </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceInvalidate</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">this</span>.invalidate();  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;  </div><div class="line">    <span class="keyword">super</span>.onDraw(canvas);  </div><div class="line">    <span class="comment">// 绘制圆  </span></div><div class="line">    canvas.drawCircle(mCircleXY, mCircleXY, mRadius, mCirclePaint);  </div><div class="line">    <span class="comment">// 绘制圆弧，逆时针绘制，角度跟  </span></div><div class="line">    canvas.drawArc(mArcRectF, <span class="number">90</span>, mSweepAngle, <span class="keyword">false</span>, mArcPaint);  </div><div class="line">    <span class="comment">// 绘制文字  </span></div><div class="line">    canvas.drawText(mShowText, <span class="number">0</span>, mShowText.length(), mCircleXY, mCircleXY + mShowTextSize / <span class="number">4</span>, mTextPaint);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当然还可以这样让调用者来设置不同的状态值：<br>这个是写在自定义控件类中的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * 让调用者来设置不同的状态值，比如这里默认值为25 </div><div class="line"> * <span class="doctag">@param</span> sweepValue </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSweepValue</span><span class="params">(<span class="keyword">float</span> sweepValue)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (sweepValue != <span class="number">0</span>) &#123;  </div><div class="line">        mSweepValue = sweepValue;  </div><div class="line">    &#125; <span class="keyword">else</span> &#123;  </div><div class="line">        mSweepValue = <span class="number">25</span>;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">this</span>.invalidate();  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="例2：音频条形图"><a href="#例2：音频条形图" class="headerlink" title="例2：音频条形图"></a>例2：音频条形图</h3><p>思路：绘制n个小矩形，每个矩形有些偏移即可<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mWidth;<span class="comment">//控件的宽度  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mRectWidth;<span class="comment">// 矩形的宽度  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mRectHeight;<span class="comment">// 矩形的高度  </span></div><div class="line"><span class="keyword">private</span> Paint paint;  </div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mRectCount;<span class="comment">// 矩形的个数  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> offset = <span class="number">5</span>;<span class="comment">// 偏移  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">double</span> mRandom;  </div><div class="line"><span class="keyword">private</span> LinearGradient lg;<span class="comment">// 渐变  </span></div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;  </div><div class="line">    paint = <span class="keyword">new</span> Paint();  </div><div class="line">    paint.setColor(Color.GREEN);  </div><div class="line">    paint.setStyle(Paint.Style.FILL);  </div><div class="line">    mRectCount = <span class="number">12</span>;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">/** </span></div><div class="line"> * 设置渐变效果：用Shader。 </div><div class="line"> */  </div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSizeChanged</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> oldw, <span class="keyword">int</span> oldh)</span> </span>&#123;  </div><div class="line">    <span class="keyword">super</span>.onSizeChanged(w, h, oldw, oldh);  </div><div class="line">    mWidth = getWidth();  </div><div class="line">    mRectHeight = getHeight();  </div><div class="line">    mRectWidth = (<span class="keyword">int</span>) (mWidth * <span class="number">0.6</span> / mRectCount);  </div><div class="line">    lg = <span class="keyword">new</span> LinearGradient(  </div><div class="line">            <span class="number">0</span>,   </div><div class="line">            <span class="number">0</span>,   </div><div class="line">            mRectWidth,   </div><div class="line">            mRectHeight,   </div><div class="line">            Color.GREEN,   </div><div class="line">            Color.BLUE,   </div><div class="line">            TileMode.CLAMP);  </div><div class="line">    paint.setShader(lg);  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">/** </span></div><div class="line"> *  </div><div class="line"> */  </div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;  </div><div class="line">    <span class="keyword">super</span>.onDraw(canvas);  </div><div class="line">    <span class="comment">// 随机的为每个矩形条计算高度，而后设置高度。  </span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mRectCount; i++) &#123;  </div><div class="line">        mRandom = Math.random();  </div><div class="line">        <span class="keyword">float</span> currentHeight = (<span class="keyword">int</span>) (mRectHeight * mRandom);  </div><div class="line">        canvas.drawRect(  </div><div class="line">                (<span class="keyword">float</span>) (mWidth * <span class="number">0.4</span> / <span class="number">2</span> + mRectWidth * i + offset * i),   </div><div class="line">                currentHeight,  </div><div class="line">                (<span class="keyword">float</span>) (mWidth * <span class="number">0.4</span> / <span class="number">2</span> + mRectWidth * (i + <span class="number">1</span>) + offset * i),   </div><div class="line">                mRectHeight,   </div><div class="line">                paint);  </div><div class="line">    &#125;  </div><div class="line">    <span class="comment">// 调用Invalidate（）方法通知View进行重绘。这里延缓1秒延迟重绘，比较容易看清楚。  </span></div><div class="line">    postInvalidateDelayed(<span class="number">1000</span>);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="自定义ViewGroup"><a href="#自定义ViewGroup" class="headerlink" title="自定义ViewGroup"></a>自定义ViewGroup</h1><p>自定义ViewGroup通常需要重写onMeasure（）方法来对子View进行测量，重写onLayout（）方法来确定子View的位置，重写onTouchEvent（）方法增加响应事件。</p>
<p>案例分析：自定义ViewGroup实现ScrollView所具有的上下滑动功能，但是在滑动的过程中，增加一个粘性效果，即当一个子View向上滑动大于一定距离后，松开手指，它将自动向上滑动，显示下一个子View。向下同理。</p>
<h2 id="首先实现类似Scrollview的功能"><a href="#首先实现类似Scrollview的功能" class="headerlink" title="首先实现类似Scrollview的功能"></a>首先实现类似Scrollview的功能</h2><p>在ViewGroup能够滚动之前，需要先放置好它的子View。使用遍历的方式来通知子View对自身进行测量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> *  </div><div class="line"> * 使用遍历的方式通知子view进行自测 </div><div class="line"> *  </div><div class="line"> * */  </div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);  </div><div class="line">    <span class="keyword">int</span> count = getChildCount();  </div><div class="line">  </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;  </div><div class="line">        View childView = getChildAt(i);  </div><div class="line">        measureChild(childView, widthMeasureSpec, heightMeasureSpec);<span class="comment">//让每个子View都显示完整的一屏  </span></div><div class="line">    &#125;<span class="comment">//这样在滑动的时候，可以比较好地实现后面的效果。  </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="放置子view"><a href="#放置子view" class="headerlink" title="放置子view"></a>放置子view</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * 计算屏幕高度 </div><div class="line"> *  </div><div class="line"> * <span class="doctag">@return</span> </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getScreenHeight</span><span class="params">()</span> </span>&#123;  </div><div class="line">    WindowManager manager = (WindowManager) getContext().getSystemService(Context.WINDOW_SERVICE);  </div><div class="line">    DisplayMetrics dm = <span class="keyword">new</span> DisplayMetrics();  </div><div class="line">    manager.getDefaultDisplay().getMetrics(dm);  </div><div class="line">    <span class="keyword">return</span> dm.heightPixels;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="comment">/** </span></div><div class="line"> * 每个view独占一屏 放置view的位置 </div><div class="line"> *  </div><div class="line"> */  </div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="comment">// 设置ViewGroup的高度，在本例中，由于让每个子View占一屏的高度，因此整个ViewGroup的高度即子View的个数乘以屏幕的高度  </span></div><div class="line">    mScreenHeight = getScreenHeight();  </div><div class="line">    <span class="keyword">int</span> childcount = getChildCount();  </div><div class="line">    MarginLayoutParams mlp = (MarginLayoutParams) getLayoutParams();  </div><div class="line">    mlp.height = childcount * mScreenHeight;  </div><div class="line">    setLayoutParams(mlp);  </div><div class="line">  </div><div class="line">    <span class="comment">//修改每个子VIew的top和bottom这两个属性，让它们能依次排列下来。  </span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childcount; i++) &#123;  </div><div class="line">        View view = getChildAt(i);  </div><div class="line">        <span class="keyword">if</span> (view.getVisibility() != View.GONE) &#123;  </div><div class="line">            view.layout(l, i * mScreenHeight, r, (i + <span class="number">1</span>) * mScreenHeight);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="响应滑动事件"><a href="#响应滑动事件" class="headerlink" title="响应滑动事件"></a>响应滑动事件</h2><ol>
<li>重写触摸事件<br>使用scrollBy方法来辅助滑动：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="keyword">int</span> action = event.getAction();  </div><div class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();  </div><div class="line">      </div><div class="line">    <span class="keyword">switch</span> (action) &#123;  </div><div class="line">      </div><div class="line">    <span class="keyword">case</span> MotionEvent.ACTION_DOWN:  </div><div class="line">        mLastY = y;  </div><div class="line">        <span class="comment">// 记录触摸起点  </span></div><div class="line">        mStart = getScrollY();  </div><div class="line">        <span class="keyword">break</span>;  </div><div class="line">          </div><div class="line">    <span class="keyword">case</span> MotionEvent.ACTION_MOVE:  </div><div class="line">        <span class="keyword">if</span> (!mScroller.isFinished()) &#123;  </div><div class="line">            mScroller.abortAnimation();  </div><div class="line">        &#125;  </div><div class="line">        <span class="comment">// dy在这里：  </span></div><div class="line">        <span class="keyword">int</span> dy = mLastY - y;  </div><div class="line">        <span class="comment">//View移动到上边沿  </span></div><div class="line">        <span class="keyword">if</span> (getScrollY() &lt; <span class="number">0</span>) &#123;  </div><div class="line">            dy = <span class="number">0</span>;  </div><div class="line">        &#125;  </div><div class="line">        <span class="comment">//view移动到下边沿  </span></div><div class="line">        <span class="keyword">if</span> (getScrollY() &gt; getHeight() - mScreenHeight) &#123;  </div><div class="line">            dy = <span class="number">0</span>;  </div><div class="line">        &#125;  </div><div class="line">        Log.e(<span class="string">"mess"</span>, mScreenHeight+<span class="string">"-----height="</span>+getHeight()+<span class="string">"-----------view="</span>+(getHeight()-mScreenHeight));  </div><div class="line">          </div><div class="line">        <span class="comment">// 让手指滑动的时候让ViewGroup的所有子View也跟着滚动dy即可，计算dy的方法有很多：  </span></div><div class="line">        scrollBy(<span class="number">0</span>, dy);  </div><div class="line">          </div><div class="line">        mLastY = y;  </div><div class="line">        <span class="keyword">break</span>;  </div><div class="line">          </div><div class="line">    <span class="keyword">case</span> MotionEvent.ACTION_UP:  </div><div class="line">        <span class="comment">// 记录触摸终点  </span></div><div class="line">        mEnd = getScrollY();  </div><div class="line">        <span class="keyword">int</span> dScrollY = mEnd - mStart;  </div><div class="line">        Log.e(<span class="string">"mess"</span>, <span class="string">"---dscrollY="</span>+dScrollY);  </div><div class="line">          </div><div class="line">        <span class="keyword">if</span> (dScrollY &gt; <span class="number">0</span>) &#123;<span class="comment">// 上滑  </span></div><div class="line">  </div><div class="line">            <span class="keyword">if</span> (dScrollY &lt; mScreenHeight / <span class="number">3</span>) &#123;<span class="comment">// 回彈效果  </span></div><div class="line">                mScroller.startScroll(<span class="number">0</span>, getScrollY(), <span class="number">0</span>, -dScrollY);  </div><div class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">// 滑到下一个view  </span></div><div class="line">                mScroller.startScroll(<span class="number">0</span>, getScrollY(), <span class="number">0</span>, mScreenHeight - dScrollY);  </div><div class="line">            &#125;  </div><div class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">// 下滑  </span></div><div class="line">            <span class="keyword">if</span> (-dScrollY &lt; mScreenHeight / <span class="number">3</span>) &#123;<span class="comment">// 回彈  </span></div><div class="line">                mScroller.startScroll(<span class="number">0</span>, getScrollY(), <span class="number">0</span>, -dScrollY);  </div><div class="line">            &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                mScroller.startScroll(<span class="number">0</span>, getScrollY(), <span class="number">0</span>, -mScreenHeight - dScrollY);  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">break</span>;  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="comment">//不要忘了，忘了这个有点坑了就  </span></div><div class="line">    postInvalidate();  </div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;  </div><div class="line">&#125;  </div><div class="line">``` </div><div class="line"></div><div class="line"><span class="number">2</span>.  实现滚动</div><div class="line">``` java</div><div class="line"><span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">super</span>.computeScroll();  </div><div class="line">        <span class="keyword">if</span> (mScroller.computeScrollOffset()) &#123;  </div><div class="line">            scrollTo(<span class="number">0</span>, mScroller.getCurrY());  </div><div class="line">            postInvalidate();  </div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag">#android</a>
          
            <a href="/tags/原创/" rel="tag">#原创</a>
          
            <a href="/tags/Android群英传/" rel="tag">#Android群英传</a>
          
            <a href="/tags/控件/" rel="tag">#控件</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/21/第一章：Android体系与系统架构丶第二章：Android开发工具新接触/" rel="next" title="第一章：Android体系与系统架构丶第二章：Android开发工具新接触">
                <i class="fa fa-chevron-left"></i> 第一章：Android体系与系统架构丶第二章：Android开发工具新接触
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/10/03/第三章：Android控件架构与自定义控件详解/"
           data-title="第三章：Android控件架构与自定义控件详解" data-url="http://yoursite.com/2016/10/03/第三章：Android控件架构与自定义控件详解/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://7xu1cb.com1.z0.glb.clouddn.com/IMG_0273.JPG"
               alt="TokgoLiang" />
          <p class="site-author-name" itemprop="name">TokgoLiang</p>
          <p class="site-description motion-element" itemprop="description">In me the tiger sniffs the rose.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://qiushao.net/" title="qiushao的博客" target="_blank">qiushao的博客</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Android控件架构"><span class="nav-number">1.</span> <span class="nav-text">Android控件架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Android控件树"><span class="nav-number">1.1.</span> <span class="nav-text">Android控件树</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android界面架构"><span class="nav-number">1.2.</span> <span class="nav-text">Android界面架构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ViewRoot和DecorView介绍"><span class="nav-number">2.</span> <span class="nav-text">ViewRoot和DecorView介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ViewRoot简介"><span class="nav-number">2.1.</span> <span class="nav-text">ViewRoot简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DecorView简介"><span class="nav-number">2.2.</span> <span class="nav-text">DecorView简介</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#View的测量"><span class="nav-number">3.</span> <span class="nav-text">View的测量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MeasureSpec简介"><span class="nav-number">3.1.</span> <span class="nav-text">MeasureSpec简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MeasurSpec和LayoutParams的对应关系"><span class="nav-number">3.2.</span> <span class="nav-text">MeasurSpec和LayoutParams的对应关系</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#View的measure过程"><span class="nav-number">4.</span> <span class="nav-text">View的measure过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#View的measure过程-1"><span class="nav-number">4.1.</span> <span class="nav-text">View的measure过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ViewGroup的measure过程"><span class="nav-number">4.2.</span> <span class="nav-text">ViewGroup的measure过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解决View的measure过程和Activity生命周期不同步的问题"><span class="nav-number">4.3.</span> <span class="nav-text">解决View的measure过程和Activity生命周期不同步的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常见Measure错误使用方法："><span class="nav-number">4.4.</span> <span class="nav-text">常见Measure错误使用方法：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#View的layout过程"><span class="nav-number">5.</span> <span class="nav-text">View的layout过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自定义View"><span class="nav-number">6.</span> <span class="nav-text">自定义View</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义View的注意点："><span class="nav-number">6.1.</span> <span class="nav-text">自定义View的注意点：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义View的分类："><span class="nav-number">6.2.</span> <span class="nav-text">自定义View的分类：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对现有控件进行拓展："><span class="nav-number">6.3.</span> <span class="nav-text">对现有控件进行拓展：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建复合控件"><span class="nav-number">6.4.</span> <span class="nav-text">创建复合控件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重写VIew来实现全新的控件"><span class="nav-number">6.5.</span> <span class="nav-text">重写VIew来实现全新的控件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#例1：弧线展示图"><span class="nav-number">6.5.1.</span> <span class="nav-text">例1：弧线展示图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#例2：音频条形图"><span class="nav-number">6.5.2.</span> <span class="nav-text">例2：音频条形图</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自定义ViewGroup"><span class="nav-number">7.</span> <span class="nav-text">自定义ViewGroup</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#首先实现类似Scrollview的功能"><span class="nav-number">7.1.</span> <span class="nav-text">首先实现类似Scrollview的功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#放置子view"><span class="nav-number">7.2.</span> <span class="nav-text">放置子view</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#响应滑动事件"><span class="nav-number">7.3.</span> <span class="nav-text">响应滑动事件</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">TokgoLiang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"tokgoliang"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
